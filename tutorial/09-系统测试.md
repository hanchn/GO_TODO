# 第9章：系统测试

本章将详细介绍如何对Go学生管理系统进行全面的测试，包括单元测试、集成测试、API测试、前端测试和性能测试。

## 9.1 测试策略

### 测试金字塔

我们采用经典的测试金字塔策略：

```
    /\     E2E测试 (少量)
   /  \    
  /____\   集成测试 (适量)
 /______\  
/__________\ 单元测试 (大量)
```

### 测试类型

1. **单元测试** - 测试单个函数或方法
2. **集成测试** - 测试组件间的交互
3. **API测试** - 测试HTTP接口
4. **前端测试** - 测试用户界面
5. **端到端测试** - 测试完整的用户流程
6. **性能测试** - 测试系统性能
7. **安全测试** - 测试安全漏洞

### 测试工具

- 🧪 **Go Testing** - Go内置测试框架
- 🔧 **Testify** - 断言和模拟库
- 🌐 **Gin Test** - HTTP测试工具
- 📊 **GoConvey** - BDD测试框架
- 🚀 **Postman** - API测试工具
- 🎭 **Playwright** - 端到端测试
- 📈 **Apache Bench** - 性能测试

## 9.2 项目测试结构

### 测试目录结构

```
student-management/
├── tests/
│   ├── unit/              # 单元测试
│   │   ├── models/
│   │   ├── controllers/
│   │   └── utils/
│   ├── integration/       # 集成测试
│   │   ├── api/
│   │   └── database/
│   ├── e2e/              # 端到端测试
│   │   ├── specs/
│   │   └── fixtures/
│   ├── performance/       # 性能测试
│   ├── security/         # 安全测试
│   └── testdata/         # 测试数据
├── mocks/                # 模拟对象
└── coverage/             # 覆盖率报告
```

### 测试配置

**文件路径：** `tests/config/test_config.go`

```go
package config

import (
	"os"
	"path/filepath"
	"runtime"
)

// TestConfig 测试配置
type TestConfig struct {
	DatabaseURL    string
	TestDataPath   string
	FixturesPath   string
	TempDir        string
	LogLevel       string
	Timeout        int
	CleanupEnabled bool
}

// GetTestConfig 获取测试配置
func GetTestConfig() *TestConfig {
	_, filename, _, _ := runtime.Caller(0)
	projectRoot := filepath.Dir(filepath.Dir(filepath.Dir(filename)))
	
	return &TestConfig{
		DatabaseURL:    getEnv("TEST_DATABASE_URL", ":memory:"),
		TestDataPath:   filepath.Join(projectRoot, "tests", "testdata"),
		FixturesPath:   filepath.Join(projectRoot, "tests", "fixtures"),
		TempDir:        filepath.Join(projectRoot, "tests", "temp"),
		LogLevel:       getEnv("TEST_LOG_LEVEL", "error"),
		Timeout:        30,
		CleanupEnabled: getEnv("TEST_CLEANUP", "true") == "true",
	}
}

func getEnv(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}
```

## 9.3 单元测试

### 模型测试

**文件路径：** `tests/unit/models/student_test.go`

```go
package models

import (
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/suite"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"

	"student-management/models"
)

// StudentModelTestSuite 学生模型测试套件
type StudentModelTestSuite struct {
	suite.Suite
	db *gorm.DB
}

// SetupSuite 设置测试套件
func (suite *StudentModelTestSuite) SetupSuite() {
	// 使用内存数据库
	db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
	suite.Require().NoError(err)
	
	// 自动迁移
	err = db.AutoMigrate(&models.Student{})
	suite.Require().NoError(err)
	
	suite.db = db
}

// TearDownSuite 清理测试套件
func (suite *StudentModelTestSuite) TearDownSuite() {
	sqlDB, _ := suite.db.DB()
	sqlDB.Close()
}

// SetupTest 每个测试前的设置
func (suite *StudentModelTestSuite) SetupTest() {
	// 清理数据
	suite.db.Exec("DELETE FROM students")
}

// TestStudentValidation 测试学生数据验证
func (suite *StudentModelTestSuite) TestStudentValidation() {
	tests := []struct {
		name    string
		student models.Student
		wantErr bool
		errMsg  string
	}{
		{
			name: "有效的学生数据",
			student: models.Student{
				Name:  "张三",
				Email: "zhangsan@example.com",
				Age:   20,
				Major: "计算机科学",
				Grade: "2023",
			},
			wantErr: false,
		},
		{
			name: "姓名为空",
			student: models.Student{
				Name:  "",
				Email: "test@example.com",
				Age:   20,
				Major: "计算机科学",
				Grade: "2023",
			},
			wantErr: true,
			errMsg:  "姓名不能为空",
		},
		{
			name: "邮箱格式错误",
			student: models.Student{
				Name:  "李四",
				Email: "invalid-email",
				Age:   20,
				Major: "计算机科学",
				Grade: "2023",
			},
			wantErr: true,
			errMsg:  "邮箱格式不正确",
		},
		{
			name: "年龄超出范围",
			student: models.Student{
				Name:  "王五",
				Email: "wangwu@example.com",
				Age:   35,
				Major: "计算机科学",
				Grade: "2023",
			},
			wantErr: true,
			errMsg:  "年龄必须在16-30之间",
		},
	}
	
	for _, tt := range tests {
		suite.Run(tt.name, func() {
			err := suite.db.Create(&tt.student).Error
			
			if tt.wantErr {
				suite.Error(err)
				suite.Contains(err.Error(), tt.errMsg)
			} else {
				suite.NoError(err)
				suite.NotZero(tt.student.ID)
			}
		})
	}
}

// TestStudentCRUD 测试学生CRUD操作
func (suite *StudentModelTestSuite) TestStudentCRUD() {
	// 创建学生
	student := models.Student{
		Name:  "测试学生",
		Email: "test@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	
	err := suite.db.Create(&student).Error
	suite.NoError(err)
	suite.NotZero(student.ID)
	
	// 读取学生
	var foundStudent models.Student
	err = suite.db.First(&foundStudent, student.ID).Error
	suite.NoError(err)
	suite.Equal(student.Name, foundStudent.Name)
	suite.Equal(student.Email, foundStudent.Email)
	
	// 更新学生
	foundStudent.Age = 21
	err = suite.db.Save(&foundStudent).Error
	suite.NoError(err)
	
	// 验证更新
	var updatedStudent models.Student
	err = suite.db.First(&updatedStudent, student.ID).Error
	suite.NoError(err)
	suite.Equal(21, updatedStudent.Age)
	
	// 软删除学生
	err = suite.db.Delete(&updatedStudent).Error
	suite.NoError(err)
	
	// 验证软删除
	var deletedStudent models.Student
	err = suite.db.First(&deletedStudent, student.ID).Error
	suite.Error(err) // 应该找不到记录
	
	// 验证软删除记录仍存在
	err = suite.db.Unscoped().First(&deletedStudent, student.ID).Error
	suite.NoError(err)
	suite.NotNil(deletedStudent.DeletedAt)
}

// TestStudentUniqueConstraints 测试唯一约束
func (suite *StudentModelTestSuite) TestStudentUniqueConstraints() {
	// 创建第一个学生
	student1 := models.Student{
		Name:  "学生1",
		Email: "duplicate@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	
	err := suite.db.Create(&student1).Error
	suite.NoError(err)
	
	// 尝试创建相同邮箱的学生
	student2 := models.Student{
		Name:  "学生2",
		Email: "duplicate@example.com", // 重复邮箱
		Age:   21,
		Major: "数学",
		Grade: "2023",
	}
	
	err = suite.db.Create(&student2).Error
	suite.Error(err) // 应该失败
	suite.Contains(err.Error(), "UNIQUE constraint failed")
}

// TestStudentSearch 测试学生搜索
func (suite *StudentModelTestSuite) TestStudentSearch() {
	// 创建测试数据
	students := []models.Student{
		{Name: "张三", Email: "zhangsan@example.com", Major: "计算机科学", Grade: "2023"},
		{Name: "李四", Email: "lisi@example.com", Major: "数学", Grade: "2022"},
		{Name: "王五", Email: "wangwu@example.com", Major: "计算机科学", Grade: "2023"},
	}
	
	for _, student := range students {
		err := suite.db.Create(&student).Error
		suite.NoError(err)
	}
	
	// 按姓名搜索
	var results []models.Student
	err := suite.db.Where("name LIKE ?", "%张%").Find(&results).Error
	suite.NoError(err)
	suite.Len(results, 1)
	suite.Equal("张三", results[0].Name)
	
	// 按专业搜索
	err = suite.db.Where("major = ?", "计算机科学").Find(&results).Error
	suite.NoError(err)
	suite.Len(results, 2)
	
	// 按年级搜索
	err = suite.db.Where("grade = ?", "2023").Find(&results).Error
	suite.NoError(err)
	suite.Len(results, 2)
}

// TestStudentTimestamps 测试时间戳
func (suite *StudentModelTestSuite) TestStudentTimestamps() {
	student := models.Student{
		Name:  "时间戳测试",
		Email: "timestamp@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	
	// 创建前时间戳应该为零值
	suite.True(student.CreatedAt.IsZero())
	suite.True(student.UpdatedAt.IsZero())
	
	// 创建学生
	err := suite.db.Create(&student).Error
	suite.NoError(err)
	
	// 创建后时间戳应该被设置
	suite.False(student.CreatedAt.IsZero())
	suite.False(student.UpdatedAt.IsZero())
	
	createdAt := student.CreatedAt
	updatedAt := student.UpdatedAt
	
	// 等待一毫秒确保时间差异
	time.Sleep(time.Millisecond)
	
	// 更新学生
	student.Age = 21
	err = suite.db.Save(&student).Error
	suite.NoError(err)
	
	// 创建时间不应该改变，更新时间应该改变
	suite.Equal(createdAt, student.CreatedAt)
	suite.True(student.UpdatedAt.After(updatedAt))
}

// 运行测试套件
func TestStudentModelSuite(t *testing.T) {
	suite.Run(t, new(StudentModelTestSuite))
}
```

### 控制器测试

**文件路径：** `tests/unit/controllers/student_controller_test.go`

```go
package controllers

import (
	"bytes"
	"encoding/json"
	"fmt"
	"net/http"
	"net/http/httptest"
	"testing"
	"strconv"

	"github.com/gin-gonic/gin"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
	"github.com/stretchr/testify/suite"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"

	"student-management/controllers"
	"student-management/models"
)

// StudentControllerTestSuite 学生控制器测试套件
type StudentControllerTestSuite struct {
	suite.Suite
	db         *gorm.DB
	router     *gin.Engine
	controller *controllers.StudentController
}

// SetupSuite 设置测试套件
func (suite *StudentControllerTestSuite) SetupSuite() {
	// 设置Gin为测试模式
	gin.SetMode(gin.TestMode)
	
	// 创建内存数据库
	db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
	suite.Require().NoError(err)
	
	// 自动迁移
	err = db.AutoMigrate(&models.Student{})
	suite.Require().NoError(err)
	
	suite.db = db
	
	// 创建控制器
	suite.controller = controllers.NewStudentController(db)
	
	// 设置路由
	suite.setupRoutes()
}

// setupRoutes 设置路由
func (suite *StudentControllerTestSuite) setupRoutes() {
	suite.router = gin.New()
	
	api := suite.router.Group("/api/v1")
	{
		api.GET("/students", suite.controller.GetAllStudents)
		api.GET("/students/:id", suite.controller.GetStudentByID)
		api.POST("/students", suite.controller.CreateStudent)
		api.PUT("/students/:id", suite.controller.UpdateStudent)
		api.DELETE("/students/:id", suite.controller.DeleteStudent)
		api.GET("/students/search", suite.controller.SearchStudents)
	}
}

// TearDownSuite 清理测试套件
func (suite *StudentControllerTestSuite) TearDownSuite() {
	sqlDB, _ := suite.db.DB()
	sqlDB.Close()
}

// SetupTest 每个测试前的设置
func (suite *StudentControllerTestSuite) SetupTest() {
	// 清理数据
	suite.db.Exec("DELETE FROM students")
}

// TestGetAllStudents 测试获取所有学生
func (suite *StudentControllerTestSuite) TestGetAllStudents() {
	// 创建测试数据
	students := []models.Student{
		{Name: "张三", Email: "zhangsan@example.com", Age: 20, Major: "计算机科学", Grade: "2023"},
		{Name: "李四", Email: "lisi@example.com", Age: 21, Major: "数学", Grade: "2022"},
	}
	
	for _, student := range students {
		suite.db.Create(&student)
	}
	
	// 发送请求
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/api/v1/students", nil)
	suite.router.ServeHTTP(w, req)
	
	// 验证响应
	suite.Equal(http.StatusOK, w.Code)
	
	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	suite.True(response["success"].(bool))
	data := response["data"].(map[string]interface{})
	studentList := data["students"].([]interface{})
	suite.Len(studentList, 2)
}

// TestGetStudentByID 测试根据ID获取学生
func (suite *StudentControllerTestSuite) TestGetStudentByID() {
	// 创建测试学生
	student := models.Student{
		Name:  "测试学生",
		Email: "test@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	suite.db.Create(&student)
	
	// 测试存在的学生
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", fmt.Sprintf("/api/v1/students/%d", student.ID), nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	suite.True(response["success"].(bool))
	studentData := response["data"].(map[string]interface{})
	suite.Equal(student.Name, studentData["name"])
	
	// 测试不存在的学生
	w = httptest.NewRecorder()
	req, _ = http.NewRequest("GET", "/api/v1/students/99999", nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusNotFound, w.Code)
}

// TestCreateStudent 测试创建学生
func (suite *StudentControllerTestSuite) TestCreateStudent() {
	tests := []struct {
		name       string
		student    map[string]interface{}
		expectCode int
		expectErr  bool
	}{
		{
			name: "有效的学生数据",
			student: map[string]interface{}{
				"name":  "新学生",
				"email": "new@example.com",
				"age":   20,
				"major": "计算机科学",
				"grade": "2023",
			},
			expectCode: http.StatusCreated,
			expectErr:  false,
		},
		{
			name: "缺少必填字段",
			student: map[string]interface{}{
				"email": "incomplete@example.com",
				"age":   20,
			},
			expectCode: http.StatusBadRequest,
			expectErr:  true,
		},
		{
			name: "无效的邮箱格式",
			student: map[string]interface{}{
				"name":  "测试学生",
				"email": "invalid-email",
				"age":   20,
				"major": "计算机科学",
				"grade": "2023",
			},
			expectCode: http.StatusBadRequest,
			expectErr:  true,
		},
	}
	
	for _, tt := range tests {
		suite.Run(tt.name, func() {
			body, _ := json.Marshal(tt.student)
			w := httptest.NewRecorder()
			req, _ := http.NewRequest("POST", "/api/v1/students", bytes.NewBuffer(body))
			req.Header.Set("Content-Type", "application/json")
			suite.router.ServeHTTP(w, req)
			
			suite.Equal(tt.expectCode, w.Code)
			
			var response map[string]interface{}
			err := json.Unmarshal(w.Body.Bytes(), &response)
			suite.NoError(err)
			
			if tt.expectErr {
				suite.False(response["success"].(bool))
				suite.NotEmpty(response["message"])
			} else {
				suite.True(response["success"].(bool))
				suite.NotNil(response["data"])
			}
		})
	}
}

// TestUpdateStudent 测试更新学生
func (suite *StudentControllerTestSuite) TestUpdateStudent() {
	// 创建测试学生
	student := models.Student{
		Name:  "原始学生",
		Email: "original@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	suite.db.Create(&student)
	
	// 更新数据
	updateData := map[string]interface{}{
		"name": "更新后的学生",
		"age":  21,
	}
	
	body, _ := json.Marshal(updateData)
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("PUT", fmt.Sprintf("/api/v1/students/%d", student.ID), bytes.NewBuffer(body))
	req.Header.Set("Content-Type", "application/json")
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	suite.True(response["success"].(bool))
	
	// 验证数据库中的数据已更新
	var updatedStudent models.Student
	suite.db.First(&updatedStudent, student.ID)
	suite.Equal("更新后的学生", updatedStudent.Name)
	suite.Equal(21, updatedStudent.Age)
	suite.Equal("original@example.com", updatedStudent.Email) // 未更新的字段保持不变
}

// TestDeleteStudent 测试删除学生
func (suite *StudentControllerTestSuite) TestDeleteStudent() {
	// 创建测试学生
	student := models.Student{
		Name:  "待删除学生",
		Email: "delete@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	suite.db.Create(&student)
	
	// 删除学生
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("DELETE", fmt.Sprintf("/api/v1/students/%d", student.ID), nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	suite.True(response["success"].(bool))
	
	// 验证学生已被软删除
	var deletedStudent models.Student
	err = suite.db.First(&deletedStudent, student.ID).Error
	suite.Error(err) // 应该找不到记录
	
	// 验证软删除记录仍存在
	err = suite.db.Unscoped().First(&deletedStudent, student.ID).Error
	suite.NoError(err)
	suite.NotNil(deletedStudent.DeletedAt)
}

// TestSearchStudents 测试搜索学生
func (suite *StudentControllerTestSuite) TestSearchStudents() {
	// 创建测试数据
	students := []models.Student{
		{Name: "张三", Email: "zhangsan@example.com", Major: "计算机科学", Grade: "2023"},
		{Name: "李四", Email: "lisi@example.com", Major: "数学", Grade: "2022"},
		{Name: "王五", Email: "wangwu@example.com", Major: "计算机科学", Grade: "2023"},
	}
	
	for _, student := range students {
		suite.db.Create(&student)
	}
	
	// 按姓名搜索
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/api/v1/students/search?name=张", nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	suite.True(response["success"].(bool))
	results := response["data"].([]interface{})
	suite.Len(results, 1)
	
	// 按专业搜索
	w = httptest.NewRecorder()
	req, _ = http.NewRequest("GET", "/api/v1/students/search?major=计算机科学", nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	err = json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	results = response["data"].([]interface{})
	suite.Len(results, 2)
}

// TestPagination 测试分页
func (suite *StudentControllerTestSuite) TestPagination() {
	// 创建15个测试学生
	for i := 1; i <= 15; i++ {
		student := models.Student{
			Name:  fmt.Sprintf("学生%d", i),
			Email: fmt.Sprintf("student%d@example.com", i),
			Age:   20,
			Major: "计算机科学",
			Grade: "2023",
		}
		suite.db.Create(&student)
	}
	
	// 测试第一页（默认每页10条）
	w := httptest.NewRecorder()
	req, _ := http.NewRequest("GET", "/api/v1/students?page=1&page_size=10", nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	var response map[string]interface{}
	err := json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	data := response["data"].(map[string]interface{})
	students := data["students"].([]interface{})
	suite.Len(students, 10)
	suite.Equal(float64(15), data["total"])
	suite.Equal(float64(2), data["pages"])
	
	// 测试第二页
	w = httptest.NewRecorder()
	req, _ = http.NewRequest("GET", "/api/v1/students?page=2&page_size=10", nil)
	suite.router.ServeHTTP(w, req)
	
	suite.Equal(http.StatusOK, w.Code)
	
	err = json.Unmarshal(w.Body.Bytes(), &response)
	suite.NoError(err)
	
	data = response["data"].(map[string]interface{})
	students = data["students"].([]interface{})
	suite.Len(students, 5) // 剩余5条记录
}

// 运行测试套件
func TestStudentControllerSuite(t *testing.T) {
	suite.Run(t, new(StudentControllerTestSuite))
}
```

## 9.4 集成测试

### API集成测试

**文件路径：** `tests/integration/api/student_api_test.go`

```go
package api

import (
	"bytes"
	"encoding/json"
	"fmt"
	"net/http"
	"net/http/httptest"
	"os"
	"testing"

	"github.com/gin-gonic/gin"
	"github.com/stretchr/testify/suite"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"

	"student-management/controllers"
	"student-management/models"
	"student-management/routes"
)

// StudentAPIIntegrationTestSuite API集成测试套件
type StudentAPIIntegrationTestSuite struct {
	suite.Suite
	db     *gorm.DB
	server *httptest.Server
	client *http.Client
}

// SetupSuite 设置测试套件
func (suite *StudentAPIIntegrationTestSuite) SetupSuite() {
	// 设置环境变量
	os.Setenv("GIN_MODE", "test")
	
	// 创建测试数据库
	db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
	suite.Require().NoError(err)
	
	// 自动迁移
	err = db.AutoMigrate(&models.Student{})
	suite.Require().NoError(err)
	
	suite.db = db
	
	// 创建Gin应用
	router := gin.New()
	router.Use(gin.Recovery())
	
	// 设置路由
	routes.SetupStudentRoutes(router, db)
	
	// 创建测试服务器
	suite.server = httptest.NewServer(router)
	suite.client = &http.Client{}
}

// TearDownSuite 清理测试套件
func (suite *StudentAPIIntegrationTestSuite) TearDownSuite() {
	suite.server.Close()
	sqlDB, _ := suite.db.DB()
	sqlDB.Close()
}

// SetupTest 每个测试前的设置
func (suite *StudentAPIIntegrationTestSuite) SetupTest() {
	// 清理数据
	suite.db.Exec("DELETE FROM students")
}

// TestStudentLifecycle 测试学生完整生命周期
func (suite *StudentAPIIntegrationTestSuite) TestStudentLifecycle() {
	// 1. 创建学生
	studentData := map[string]interface{}{
		"name":  "集成测试学生",
		"email": "integration@example.com",
		"age":   20,
		"major": "计算机科学",
		"grade": "2023",
	}
	
	body, _ := json.Marshal(studentData)
	resp, err := suite.client.Post(
		suite.server.URL+"/api/v1/students",
		"application/json",
		bytes.NewBuffer(body),
	)
	suite.NoError(err)
	suite.Equal(http.StatusCreated, resp.StatusCode)
	
	var createResponse map[string]interface{}
	json.NewDecoder(resp.Body).Decode(&createResponse)
	resp.Body.Close()
	
	suite.True(createResponse["success"].(bool))
	studentID := int(createResponse["data"].(map[string]interface{})["id"].(float64))
	
	// 2. 获取学生详情
	resp, err = suite.client.Get(fmt.Sprintf("%s/api/v1/students/%d", suite.server.URL, studentID))
	suite.NoError(err)
	suite.Equal(http.StatusOK, resp.StatusCode)
	
	var getResponse map[string]interface{}
	json.NewDecoder(resp.Body).Decode(&getResponse)
	resp.Body.Close()
	
	suite.True(getResponse["success"].(bool))
	student := getResponse["data"].(map[string]interface{})
	suite.Equal("集成测试学生", student["name"])
	
	// 3. 更新学生
	updateData := map[string]interface{}{
		"name": "更新后的集成测试学生",
		"age":  21,
	}
	
	body, _ = json.Marshal(updateData)
	req, _ := http.NewRequest("PUT", fmt.Sprintf("%s/api/v1/students/%d", suite.server.URL, studentID), bytes.NewBuffer(body))
	req.Header.Set("Content-Type", "application/json")
	resp, err = suite.client.Do(req)
	suite.NoError(err)
	suite.Equal(http.StatusOK, resp.StatusCode)
	resp.Body.Close()
	
	// 4. 验证更新
	resp, err = suite.client.Get(fmt.Sprintf("%s/api/v1/students/%d", suite.server.URL, studentID))
	suite.NoError(err)
	
	json.NewDecoder(resp.Body).Decode(&getResponse)
	resp.Body.Close()
	
	student = getResponse["data"].(map[string]interface{})
	suite.Equal("更新后的集成测试学生", student["name"])
	suite.Equal(float64(21), student["age"])
	
	// 5. 删除学生
	req, _ = http.NewRequest("DELETE", fmt.Sprintf("%s/api/v1/students/%d", suite.server.URL, studentID), nil)
	resp, err = suite.client.Do(req)
	suite.NoError(err)
	suite.Equal(http.StatusOK, resp.StatusCode)
	resp.Body.Close()
	
	// 6. 验证删除
	resp, err = suite.client.Get(fmt.Sprintf("%s/api/v1/students/%d", suite.server.URL, studentID))
	suite.NoError(err)
	suite.Equal(http.StatusNotFound, resp.StatusCode)
	resp.Body.Close()
}

// TestBulkOperations 测试批量操作
func (suite *StudentAPIIntegrationTestSuite) TestBulkOperations() {
	// 创建多个学生
	students := []map[string]interface{}{
		{"name": "批量学生1", "email": "bulk1@example.com", "age": 20, "major": "计算机科学", "grade": "2023"},
		{"name": "批量学生2", "email": "bulk2@example.com", "age": 21, "major": "数学", "grade": "2022"},
		{"name": "批量学生3", "email": "bulk3@example.com", "age": 22, "major": "物理", "grade": "2021"},
	}
	
	var studentIDs []int
	for _, studentData := range students {
		body, _ := json.Marshal(studentData)
		resp, err := suite.client.Post(
			suite.server.URL+"/api/v1/students",
			"application/json",
			bytes.NewBuffer(body),
		)
		suite.NoError(err)
		suite.Equal(http.StatusCreated, resp.StatusCode)
		
		var response map[string]interface{}
		json.NewDecoder(resp.Body).Decode(&response)
		resp.Body.Close()
		
		studentID := int(response["data"].(map[string]interface{})["id"].(float64))
		studentIDs = append(studentIDs, studentID)
	}
	
	// 获取所有学生
	resp, err := suite.client.Get(suite.server.URL + "/api/v1/students")
	suite.NoError(err)
	suite.Equal(http.StatusOK, resp.StatusCode)
	
	var listResponse map[string]interface{}
	json.NewDecoder(resp.Body).Decode(&listResponse)
	resp.Body.Close()
	
	data := listResponse["data"].(map[string]interface{})
	studentList := data["students"].([]interface{})
	suite.Len(studentList, 3)
	suite.Equal(float64(3), data["total"])
	
	// 搜索测试
	resp, err = suite.client.Get(suite.server.URL + "/api/v1/students/search?major=计算机科学")
	suite.NoError(err)
	suite.Equal(http.StatusOK, resp.StatusCode)
	
	var searchResponse map[string]interface{}
	json.NewDecoder(resp.Body).Decode(&searchResponse)
	resp.Body.Close()
	
	searchResults := searchResponse["data"].([]interface{})
	suite.Len(searchResults, 1)
}

// TestErrorHandling 测试错误处理
func (suite *StudentAPIIntegrationTestSuite) TestErrorHandling() {
	// 测试无效的JSON
	resp, err := suite.client.Post(
		suite.server.URL+"/api/v1/students",
		"application/json",
		bytes.NewBuffer([]byte("invalid json")),
	)
	suite.NoError(err)
	suite.Equal(http.StatusBadRequest, resp.StatusCode)
	resp.Body.Close()
	
	// 测试不存在的学生
	resp, err = suite.client.Get(suite.server.URL + "/api/v1/students/99999")
	suite.NoError(err)
	suite.Equal(http.StatusNotFound, resp.StatusCode)
	resp.Body.Close()
	
	// 测试无效的ID格式
	resp, err = suite.client.Get(suite.server.URL + "/api/v1/students/invalid")
	suite.NoError(err)
	suite.Equal(http.StatusBadRequest, resp.StatusCode)
	resp.Body.Close()
}

// TestConcurrentAccess 测试并发访问
func (suite *StudentAPIIntegrationTestSuite) TestConcurrentAccess() {
	// 创建一个学生用于并发测试
	studentData := map[string]interface{}{
		"name":  "并发测试学生",
		"email": "concurrent@example.com",
		"age":   20,
		"major": "计算机科学",
		"grade": "2023",
	}
	
	body, _ := json.Marshal(studentData)
	resp, err := suite.client.Post(
		suite.server.URL+"/api/v1/students",
		"application/json",
		bytes.NewBuffer(body),
	)
	suite.NoError(err)
	resp.Body.Close()
	
	// 并发读取测试
	done := make(chan bool, 10)
	for i := 0; i < 10; i++ {
		go func() {
			resp, err := suite.client.Get(suite.server.URL + "/api/v1/students")
			suite.NoError(err)
			suite.Equal(http.StatusOK, resp.StatusCode)
			resp.Body.Close()
			done <- true
		}()
	}
	
	// 等待所有goroutine完成
	for i := 0; i < 10; i++ {
		<-done
	}
}

// 运行测试套件
func TestStudentAPIIntegrationSuite(t *testing.T) {
	suite.Run(t, new(StudentAPIIntegrationTestSuite))
}
```

## 9.5 性能测试

### 基准测试

**文件路径：** `tests/performance/benchmark_test.go`

```go
package performance

import (
	"bytes"
	"encoding/json"
	"fmt"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/gin-gonic/gin"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"

	"student-management/controllers"
	"student-management/models"
)

// 基准测试设置
func setupBenchmark() (*gin.Engine, *gorm.DB) {
	gin.SetMode(gin.ReleaseMode)
	
	// 创建内存数据库
	db, _ := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
	db.AutoMigrate(&models.Student{})
	
	// 创建路由
	router := gin.New()
	controller := controllers.NewStudentController(db)
	
	api := router.Group("/api/v1")
	{
		api.GET("/students", controller.GetAllStudents)
		api.GET("/students/:id", controller.GetStudentByID)
		api.POST("/students", controller.CreateStudent)
		api.PUT("/students/:id", controller.UpdateStudent)
		api.DELETE("/students/:id", controller.DeleteStudent)
		api.GET("/students/search", controller.SearchStudents)
	}
	
	return router, db
}

// 创建测试数据
func createTestData(db *gorm.DB, count int) {
	for i := 1; i <= count; i++ {
		student := models.Student{
			Name:  fmt.Sprintf("学生%d", i),
			Email: fmt.Sprintf("student%d@example.com", i),
			Age:   20 + (i % 10),
			Major: []string{"计算机科学", "数学", "物理", "化学"}[i%4],
			Grade: fmt.Sprintf("%d", 2020+(i%4)),
		}
		db.Create(&student)
	}
}

// BenchmarkGetAllStudents 基准测试获取所有学生
func BenchmarkGetAllStudents(b *testing.B) {
	router, db := setupBenchmark()
	createTestData(db, 1000) // 创建1000条测试数据
	
	b.ResetTimer()
	b.RunParallel(func(pb *testing.PB) {
		for pb.Next() {
			w := httptest.NewRecorder()
			req, _ := http.NewRequest("GET", "/api/v1/students", nil)
			router.ServeHTTP(w, req)
			
			if w.Code != http.StatusOK {
				b.Errorf("Expected status 200, got %d", w.Code)
			}
		}
	})
}

// BenchmarkGetStudentByID 基准测试根据ID获取学生
func BenchmarkGetStudentByID(b *testing.B) {
	router, db := setupBenchmark()
	createTestData(db, 1000)
	
	b.ResetTimer()
	b.RunParallel(func(pb *testing.PB) {
		for pb.Next() {
			w := httptest.NewRecorder()
			req, _ := http.NewRequest("GET", "/api/v1/students/500", nil)
			router.ServeHTTP(w, req)
			
			if w.Code != http.StatusOK {
				b.Errorf("Expected status 200, got %d", w.Code)
			}
		}
	})
}

// BenchmarkCreateStudent 基准测试创建学生
func BenchmarkCreateStudent(b *testing.B) {
	router, _ := setupBenchmark()
	
	studentData := map[string]interface{}{
		"name":  "基准测试学生",
		"email": "benchmark@example.com",
		"age":   20,
		"major": "计算机科学",
		"grade": "2023",
	}
	
	body, _ := json.Marshal(studentData)
	
	b.ResetTimer()
	for i := 0; i < b.N; i++ {
		// 为每次测试修改邮箱以避免重复
		studentData["email"] = fmt.Sprintf("benchmark%d@example.com", i)
		body, _ = json.Marshal(studentData)
		
		w := httptest.NewRecorder()
		req, _ := http.NewRequest("POST", "/api/v1/students", bytes.NewBuffer(body))
		req.Header.Set("Content-Type", "application/json")
		router.ServeHTTP(w, req)
		
		if w.Code != http.StatusCreated {
			b.Errorf("Expected status 201, got %d", w.Code)
		}
	}
}

// BenchmarkSearchStudents 基准测试搜索学生
func BenchmarkSearchStudents(b *testing.B) {
	router, db := setupBenchmark()
	createTestData(db, 1000)
	
	b.ResetTimer()
	b.RunParallel(func(pb *testing.PB) {
		for pb.Next() {
			w := httptest.NewRecorder()
			req, _ := http.NewRequest("GET", "/api/v1/students/search?name=学生1", nil)
			router.ServeHTTP(w, req)
			
			if w.Code != http.StatusOK {
				b.Errorf("Expected status 200, got %d", w.Code)
			}
		}
	})
}

// BenchmarkDatabaseOperations 基准测试数据库操作
func BenchmarkDatabaseOperations(b *testing.B) {
	_, db := setupBenchmark()
	
	b.Run("Create", func(b *testing.B) {
		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			student := models.Student{
				Name:  fmt.Sprintf("基准学生%d", i),
				Email: fmt.Sprintf("bench%d@example.com", i),
				Age:   20,
				Major: "计算机科学",
				Grade: "2023",
			}
			db.Create(&student)
		}
	})
	
	b.Run("Read", func(b *testing.B) {
		// 先创建一些数据
		createTestData(db, 100)
		
		b.ResetTimer()
		b.RunParallel(func(pb *testing.PB) {
			for pb.Next() {
				var student models.Student
				db.First(&student, 50)
			}
		})
	})
	
	b.Run("Update", func(b *testing.B) {
		// 先创建一些数据
		createTestData(db, 100)
		
		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			var student models.Student
			db.First(&student, 50)
			student.Age = 25
			db.Save(&student)
		}
	})
	
	b.Run("Delete", func(b *testing.B) {
		// 为每次删除创建新数据
		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			student := models.Student{
				Name:  fmt.Sprintf("删除测试%d", i),
				Email: fmt.Sprintf("delete%d@example.com", i),
				Age:   20,
				Major: "计算机科学",
				Grade: "2023",
			}
			db.Create(&student)
			db.Delete(&student)
		}
	})
}

// BenchmarkMemoryUsage 内存使用基准测试
func BenchmarkMemoryUsage(b *testing.B) {
	router, db := setupBenchmark()
	createTestData(db, 10000) // 创建大量数据
	
	b.ResetTimer()
	b.ReportAllocs() // 报告内存分配
	
	for i := 0; i < b.N; i++ {
		w := httptest.NewRecorder()
		req, _ := http.NewRequest("GET", "/api/v1/students?page=1&page_size=100", nil)
		router.ServeHTTP(w, req)
	}
}
```

## 9.6 端到端测试

### Playwright测试

**文件路径：** `tests/e2e/student_e2e_test.go`

```go
package e2e

import (
	"context"
	"testing"
	"time"

	"github.com/playwright-community/playwright-go"
	"github.com/stretchr/testify/suite"
)

// StudentE2ETestSuite 端到端测试套件
type StudentE2ETestSuite struct {
	suite.Suite
	browser   playwright.Browser
	context   playwright.BrowserContext
	page      playwright.Page
	playwright *playwright.Playwright
	baseURL   string
}

// SetupSuite 设置测试套件
func (suite *StudentE2ETestSuite) SetupSuite() {
	// 启动Playwright
	pw, err := playwright.Run()
	suite.Require().NoError(err)
	suite.playwright = pw
	
	// 启动浏览器
	browser, err := pw.Chromium.Launch(playwright.BrowserTypeLaunchOptions{
		Headless: playwright.Bool(true),
	})
	suite.Require().NoError(err)
	suite.browser = browser
	
	// 设置基础URL
	suite.baseURL = "http://localhost:8080"
}

// TearDownSuite 清理测试套件
func (suite *StudentE2ETestSuite) TearDownSuite() {
	if suite.browser != nil {
		suite.browser.Close()
	}
	if suite.playwright != nil {
		suite.playwright.Stop()
	}
}

// SetupTest 每个测试前的设置
func (suite *StudentE2ETestSuite) SetupTest() {
	// 创建新的浏览器上下文
	context, err := suite.browser.NewContext()
	suite.Require().NoError(err)
	suite.context = context
	
	// 创建新页面
	page, err := context.NewPage()
	suite.Require().NoError(err)
	suite.page = page
}

// TearDownTest 每个测试后的清理
func (suite *StudentE2ETestSuite) TearDownTest() {
	if suite.page != nil {
		suite.page.Close()
	}
	if suite.context != nil {
		suite.context.Close()
	}
}

// TestStudentManagementFlow 测试学生管理完整流程
func (suite *StudentE2ETestSuite) TestStudentManagementFlow() {
	// 导航到学生管理页面
	_, err := suite.page.Goto(suite.baseURL + "/students")
	suite.NoError(err)
	
	// 等待页面加载
	err = suite.page.WaitForSelector("#student-table", playwright.PageWaitForSelectorOptions{
		Timeout: playwright.Float(5000),
	})
	suite.NoError(err)
	
	// 验证页面标题
	title, err := suite.page.Title()
	suite.NoError(err)
	suite.Contains(title, "学生管理")
	
	// 点击添加学生按钮
	err = suite.page.Click("#add-student-btn")
	suite.NoError(err)
	
	// 等待模态框出现
	err = suite.page.WaitForSelector("#student-modal", playwright.PageWaitForSelectorOptions{
		State: playwright.WaitForSelectorStateVisible,
	})
	suite.NoError(err)
	
	// 填写学生信息
	err = suite.page.Fill("#student-name", "端到端测试学生")
	suite.NoError(err)
	
	err = suite.page.Fill("#student-email", "e2e@example.com")
	suite.NoError(err)
	
	err = suite.page.Fill("#student-age", "20")
	suite.NoError(err)
	
	err = suite.page.SelectOption("#student-major", "计算机科学")
	suite.NoError(err)
	
	err = suite.page.Fill("#student-grade", "2023")
	suite.NoError(err)
	
	// 提交表单
	err = suite.page.Click("#save-student-btn")
	suite.NoError(err)
	
	// 等待成功消息
	err = suite.page.WaitForSelector(".success-message", playwright.PageWaitForSelectorOptions{
		Timeout: playwright.Float(3000),
	})
	suite.NoError(err)
	
	// 验证学生已添加到表格中
	err = suite.page.WaitForSelector("text=端到端测试学生", playwright.PageWaitForSelectorOptions{
		Timeout: playwright.Float(3000),
	})
	suite.NoError(err)
	
	// 测试搜索功能
	err = suite.page.Fill("#search-input", "端到端")
	suite.NoError(err)
	
	err = suite.page.Click("#search-btn")
	suite.NoError(err)
	
	// 验证搜索结果
	time.Sleep(1 * time.Second) // 等待搜索完成
	rows, err := suite.page.QuerySelectorAll("#student-table tbody tr")
	suite.NoError(err)
	suite.Len(rows, 1)
	
	// 测试编辑功能
	err = suite.page.Click(".edit-btn")
	suite.NoError(err)
	
	err = suite.page.WaitForSelector("#student-modal", playwright.PageWaitForSelectorOptions{
		State: playwright.WaitForSelectorStateVisible,
	})
	suite.NoError(err)
	
	// 修改年龄
	err = suite.page.Fill("#student-age", "21")
	suite.NoError(err)
	
	err = suite.page.Click("#save-student-btn")
	suite.NoError(err)
	
	// 验证更新成功
	err = suite.page.WaitForSelector(".success-message")
	suite.NoError(err)
	
	// 测试删除功能
	err = suite.page.Click(".delete-btn")
	suite.NoError(err)
	
	// 确认删除
	suite.page.OnDialog(func(dialog playwright.Dialog) {
		dialog.Accept()
	})
	
	// 验证学生已被删除
	err = suite.page.WaitForSelector("text=端到端测试学生", playwright.PageWaitForSelectorOptions{
		State:   playwright.WaitForSelectorStateDetached,
		Timeout: playwright.Float(3000),
	})
	suite.NoError(err)
}

// TestResponsiveDesign 测试响应式设计
func (suite *StudentE2ETestSuite) TestResponsiveDesign() {
	// 测试桌面视图
	err := suite.page.SetViewportSize(1920, 1080)
	suite.NoError(err)
	
	_, err = suite.page.Goto(suite.baseURL + "/students")
	suite.NoError(err)
	
	// 验证桌面布局
	isVisible, err := suite.page.IsVisible(".sidebar")
	suite.NoError(err)
	suite.True(isVisible)
	
	// 测试平板视图
	err = suite.page.SetViewportSize(768, 1024)
	suite.NoError(err)
	
	time.Sleep(500 * time.Millisecond) // 等待布局调整
	
	// 测试手机视图
	err = suite.page.SetViewportSize(375, 667)
	suite.NoError(err)
	
	time.Sleep(500 * time.Millisecond)
	
	// 验证移动端导航
	isVisible, err = suite.page.IsVisible(".mobile-menu-btn")
	suite.NoError(err)
	suite.True(isVisible)
}

// TestAccessibility 测试可访问性
func (suite *StudentE2ETestSuite) TestAccessibility() {
	_, err := suite.page.Goto(suite.baseURL + "/students")
	suite.NoError(err)
	
	// 测试键盘导航
	err = suite.page.Press("body", "Tab")
	suite.NoError(err)
	
	// 验证焦点管理
	focusedElement, err := suite.page.Locator(":focus").First().GetAttribute("id")
	suite.NoError(err)
	suite.NotEmpty(focusedElement)
	
	// 测试ARIA标签
	ariaLabel, err := suite.page.GetAttribute("#add-student-btn", "aria-label")
	suite.NoError(err)
	suite.NotEmpty(ariaLabel)
}

// 运行测试套件
func TestStudentE2ESuite(t *testing.T) {
	suite.Run(t, new(StudentE2ETestSuite))
}
```

## 9.7 测试工具和脚本

### 测试运行脚本

**文件路径：** `scripts/test.sh`

```bash
#!/bin/bash

# 测试运行脚本
set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 打印带颜色的消息
print_message() {
    echo -e "${2}${1}${NC}"
}

# 检查Go环境
check_go_env() {
    if ! command -v go &> /dev/null; then
        print_message "Go未安装或不在PATH中" $RED
        exit 1
    fi
    print_message "Go版本: $(go version)" $GREEN
}

# 安装测试依赖
install_deps() {
    print_message "安装测试依赖..." $YELLOW
    go mod tidy
    go mod download
}

# 运行单元测试
run_unit_tests() {
    print_message "运行单元测试..." $YELLOW
    go test -v -race -coverprofile=coverage/unit.out ./tests/unit/...
}

# 运行集成测试
run_integration_tests() {
    print_message "运行集成测试..." $YELLOW
    go test -v -race -coverprofile=coverage/integration.out ./tests/integration/...
}

# 运行性能测试
run_benchmark_tests() {
    print_message "运行性能测试..." $YELLOW
    go test -v -bench=. -benchmem ./tests/performance/...
}

# 运行端到端测试
run_e2e_tests() {
    print_message "运行端到端测试..." $YELLOW
    # 启动应用服务器
    go run main.go &
    SERVER_PID=$!
    
    # 等待服务器启动
    sleep 3
    
    # 运行E2E测试
    go test -v ./tests/e2e/...
    
    # 停止服务器
    kill $SERVER_PID
}

# 生成覆盖率报告
generate_coverage() {
    print_message "生成覆盖率报告..." $YELLOW
    
    # 合并覆盖率文件
    echo "mode: atomic" > coverage/total.out
    tail -n +2 coverage/unit.out >> coverage/total.out
    tail -n +2 coverage/integration.out >> coverage/total.out
    
    # 生成HTML报告
    go tool cover -html=coverage/total.out -o coverage/coverage.html
    
    # 显示覆盖率统计
    go tool cover -func=coverage/total.out
}

# 运行代码质量检查
run_quality_checks() {
    print_message "运行代码质量检查..." $YELLOW
    
    # 格式检查
    if ! gofmt -l . | grep -q .; then
        print_message "代码格式检查通过" $GREEN
    else
        print_message "代码格式检查失败" $RED
        gofmt -l .
        exit 1
    fi
    
    # 静态分析
    if command -v golangci-lint &> /dev/null; then
        golangci-lint run
    else
        print_message "golangci-lint未安装，跳过静态分析" $YELLOW
    fi
    
    # 安全检查
    if command -v gosec &> /dev/null; then
        gosec ./...
    else
        print_message "gosec未安装，跳过安全检查" $YELLOW
    fi
}

# 清理测试环境
cleanup() {
    print_message "清理测试环境..." $YELLOW
    rm -f test.db
    rm -rf coverage/temp
}

# 主函数
main() {
    print_message "开始运行测试套件" $GREEN
    
    # 创建覆盖率目录
    mkdir -p coverage
    
    # 检查环境
    check_go_env
    
    # 安装依赖
    install_deps
    
    # 根据参数运行不同类型的测试
    case "${1:-all}" in
        "unit")
            run_unit_tests
            ;;
        "integration")
            run_integration_tests
            ;;
        "benchmark")
            run_benchmark_tests
            ;;
        "e2e")
            run_e2e_tests
            ;;
        "quality")
            run_quality_checks
            ;;
        "all")
            run_quality_checks
            run_unit_tests
            run_integration_tests
            run_benchmark_tests
            # run_e2e_tests  # 可选，需要浏览器环境
            generate_coverage
            ;;
        *)
            print_message "用法: $0 [unit|integration|benchmark|e2e|quality|all]" $YELLOW
            exit 1
            ;;
    esac
    
    # 清理
    cleanup
    
    print_message "测试完成!" $GREEN
}

# 运行主函数
main "$@"
```

### Makefile

**文件路径：** `Makefile`

```makefile
# Go学生管理系统 Makefile

# 变量定义
GO_VERSION := 1.21
APP_NAME := student-management
BUILD_DIR := build
COVERAGE_DIR := coverage
DOCS_DIR := docs

# 默认目标
.DEFAULT_GOAL := help

# 帮助信息
.PHONY: help
help: ## 显示帮助信息
	@echo "可用的命令:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# 环境设置
.PHONY: setup
setup: ## 设置开发环境
	@echo "设置开发环境..."
	go mod tidy
	go mod download
	mkdir -p $(BUILD_DIR) $(COVERAGE_DIR) $(DOCS_DIR)

# 代码格式化
.PHONY: fmt
fmt: ## 格式化代码
	@echo "格式化代码..."
	gofmt -w .
	go mod tidy

# 代码检查
.PHONY: lint
lint: ## 运行代码检查
	@echo "运行代码检查..."
	golangci-lint run

# 安全检查
.PHONY: security
security: ## 运行安全检查
	@echo "运行安全检查..."
	gosec ./...

# 单元测试
.PHONY: test-unit
test-unit: ## 运行单元测试
	@echo "运行单元测试..."
	go test -v -race -coverprofile=$(COVERAGE_DIR)/unit.out ./tests/unit/...

# 集成测试
.PHONY: test-integration
test-integration: ## 运行集成测试
	@echo "运行集成测试..."
	go test -v -race -coverprofile=$(COVERAGE_DIR)/integration.out ./tests/integration/...

# 性能测试
.PHONY: test-benchmark
test-benchmark: ## 运行性能测试
	@echo "运行性能测试..."
	go test -v -bench=. -benchmem ./tests/performance/...

# 端到端测试
.PHONY: test-e2e
test-e2e: ## 运行端到端测试
	@echo "运行端到端测试..."
	./scripts/test.sh e2e

# 运行所有测试
.PHONY: test
test: ## 运行所有测试
	@echo "运行所有测试..."
	./scripts/test.sh all

# 生成覆盖率报告
.PHONY: coverage
coverage: test-unit test-integration ## 生成覆盖率报告
	@echo "生成覆盖率报告..."
	echo "mode: atomic" > $(COVERAGE_DIR)/total.out
	tail -n +2 $(COVERAGE_DIR)/unit.out >> $(COVERAGE_DIR)/total.out
	tail -n +2 $(COVERAGE_DIR)/integration.out >> $(COVERAGE_DIR)/total.out
	go tool cover -html=$(COVERAGE_DIR)/total.out -o $(COVERAGE_DIR)/coverage.html
	go tool cover -func=$(COVERAGE_DIR)/total.out

# 构建应用
.PHONY: build
build: ## 构建应用
	@echo "构建应用..."
	go build -o $(BUILD_DIR)/$(APP_NAME) .

# 运行应用
.PHONY: run
run: ## 运行应用
	@echo "运行应用..."
	go run main.go

# 开发模式运行
.PHONY: dev
dev: ## 开发模式运行（带热重载）
	@echo "开发模式运行..."
	air

# 清理
.PHONY: clean
clean: ## 清理构建文件
	@echo "清理构建文件..."
	rm -rf $(BUILD_DIR) $(COVERAGE_DIR)/*.out
	rm -f test.db

# 生成文档
.PHONY: docs
docs: ## 生成API文档
	@echo "生成API文档..."
	swag init

# Docker构建
.PHONY: docker-build
docker-build: ## 构建Docker镜像
	@echo "构建Docker镜像..."
	docker build -t $(APP_NAME) .

# Docker运行
.PHONY: docker-run
docker-run: ## 运行Docker容器
	@echo "运行Docker容器..."
	docker run -p 8080:8080 $(APP_NAME)

# 代码质量检查
.PHONY: quality
quality: fmt lint security ## 运行所有代码质量检查

# CI/CD流水线
.PHONY: ci
ci: quality test coverage ## CI流水线

# 安装工具
.PHONY: install-tools
install-tools: ## 安装开发工具
	@echo "安装开发工具..."
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
	go install github.com/swaggo/swag/cmd/swag@latest
	go install github.com/cosmtrek/air@latest
```

## 9.8 持续集成配置

### GitHub Actions

**文件路径：** `.github/workflows/test.yml`

```yaml
name: 测试流水线

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: [1.20, 1.21]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: 设置Go环境
      uses: actions/setup-go@v3
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: 缓存Go模块
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: 安装依赖
      run: |
        go mod tidy
        go mod download
    
    - name: 代码格式检查
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "代码格式不正确:"
          gofmt -s -l .
          exit 1
        fi
    
    - name: 安装golangci-lint
      run: |
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2
    
    - name: 运行代码检查
      run: golangci-lint run
    
    - name: 运行单元测试
      run: |
        mkdir -p coverage
        go test -v -race -coverprofile=coverage/unit.out ./tests/unit/...
    
    - name: 运行集成测试
      run: |
        go test -v -race -coverprofile=coverage/integration.out ./tests/integration/...
    
    - name: 生成覆盖率报告
      run: |
        echo "mode: atomic" > coverage/total.out
        tail -n +2 coverage/unit.out >> coverage/total.out
        tail -n +2 coverage/integration.out >> coverage/total.out
        go tool cover -func=coverage/total.out
    
    - name: 上传覆盖率到Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/total.out
        flags: unittests
        name: codecov-umbrella
    
    - name: 构建应用
      run: go build -v .
```

## 9.9 测试最佳实践

### 测试原则

1. **测试金字塔** - 大量单元测试，适量集成测试，少量E2E测试
2. **快速反馈** - 测试应该快速运行并提供即时反馈
3. **独立性** - 测试之间应该相互独立
4. **可重复性** - 测试结果应该一致和可重复
5. **可维护性** - 测试代码应该易于理解和维护

### 命名约定

```go
// 测试函数命名：Test + 功能名称 + 场景
func TestCreateStudent_ValidData_Success(t *testing.T) {}
func TestCreateStudent_InvalidEmail_ReturnsError(t *testing.T) {}
func TestCreateStudent_DuplicateEmail_ReturnsError(t *testing.T) {}

// 基准测试命名：Benchmark + 功能名称
func BenchmarkGetAllStudents(b *testing.B) {}
func BenchmarkCreateStudent(b *testing.B) {}
```

### 测试数据管理

```go
// 使用工厂函数创建测试数据
func createTestStudent(overrides ...func(*models.Student)) models.Student {
	student := models.Student{
		Name:  "测试学生",
		Email: "test@example.com",
		Age:   20,
		Major: "计算机科学",
		Grade: "2023",
	}
	
	for _, override := range overrides {
		override(&student)
	}
	
	return student
}

// 使用示例
student := createTestStudent(func(s *models.Student) {
	s.Age = 25
	s.Major = "数学"
})
```

### 错误处理测试

```go
func TestCreateStudent_DatabaseError_ReturnsError(t *testing.T) {
	// 模拟数据库错误
	mockDB := &MockDB{}
	mockDB.On("Create", mock.Anything).Return(errors.New("database error"))
	
	controller := NewStudentController(mockDB)
	
	// 测试错误处理
	err := controller.CreateStudent(validStudentData)
	assert.Error(t, err)
	assert.Contains(t, err.Error(), "database error")
}
```

## 9.10 总结

本章详细介绍了Go学生管理系统的测试策略和实现：

### 核心特性

- ✅ **完整的测试覆盖** - 单元、集成、性能、E2E测试
- 🔧 **自动化测试流水线** - CI/CD集成
- 📊 **覆盖率报告** - 详细的测试覆盖率分析
- 🚀 **性能基准测试** - 系统性能监控
- 🎭 **端到端测试** - 完整用户流程验证
- 🛡️ **代码质量检查** - 静态分析和安全检查

### 最佳实践

1. **测试驱动开发** - 先写测试，再写实现
2. **持续集成** - 每次提交都运行测试
3. **测试数据隔离** - 每个测试使用独立的数据
4. **模拟外部依赖** - 使用Mock对象隔离测试
5. **性能监控** - 定期运行基准测试
6. **文档化测试** - 测试即文档

通过本章的学习，你将掌握如何构建一个健壮、可靠的测试体系，确保系统的质量和稳定性。