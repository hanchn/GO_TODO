# ç¬¬6ç« ï¼šè·¯ç”±é…ç½®

æœ¬ç« å°†è¯¦ç»†ä»‹ç»å¦‚ä½•é…ç½®å’Œç»„ç»‡åº”ç”¨ç¨‹åºçš„è·¯ç”±ï¼ŒåŒ…æ‹¬RESTful APIè®¾è®¡ã€è·¯ç”±åˆ†ç»„ã€ä¸­é—´ä»¶åº”ç”¨å’ŒAPIæ–‡æ¡£ç”Ÿæˆã€‚

## 6.1 è·¯ç”±åŸºç¡€æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯è·¯ç”±

è·¯ç”±ï¼ˆRoutingï¼‰æ˜¯Webåº”ç”¨ç¨‹åºä¸­å°†HTTPè¯·æ±‚æ˜ å°„åˆ°ç›¸åº”å¤„ç†å‡½æ•°çš„æœºåˆ¶ã€‚åœ¨Ginæ¡†æ¶ä¸­ï¼Œè·¯ç”±è´Ÿè´£ï¼š

- ğŸŒ **URLæ˜ å°„**ï¼šå°†URLè·¯å¾„æ˜ å°„åˆ°æ§åˆ¶å™¨æ–¹æ³•
- ğŸ”„ **HTTPæ–¹æ³•å¤„ç†**ï¼šæ”¯æŒGETã€POSTã€PUTã€DELETEç­‰æ–¹æ³•
- ğŸ“Š **å‚æ•°æå–**ï¼šä»URLè·¯å¾„å’ŒæŸ¥è¯¢å‚æ•°ä¸­æå–æ•°æ®
- ğŸ›¡ï¸ **ä¸­é—´ä»¶åº”ç”¨**ï¼šåœ¨è¯·æ±‚å¤„ç†å‰åæ‰§è¡Œä¸­é—´ä»¶
- ğŸ“ **APIæ–‡æ¡£ç”Ÿæˆ**ï¼šä¸ºAPIç«¯ç‚¹ç”Ÿæˆæ–‡æ¡£

### RESTful APIè®¾è®¡åŸåˆ™

```
èµ„æºæ“ä½œæ˜ å°„ï¼š
GET    /api/v1/students        # è·å–æ‰€æœ‰å­¦ç”Ÿ
GET    /api/v1/students/:id    # è·å–æŒ‡å®šå­¦ç”Ÿ
POST   /api/v1/students        # åˆ›å»ºæ–°å­¦ç”Ÿ
PUT    /api/v1/students/:id    # æ›´æ–°æŒ‡å®šå­¦ç”Ÿ
DELETE /api/v1/students/:id    # åˆ é™¤æŒ‡å®šå­¦ç”Ÿ

æœç´¢å’Œè¿‡æ»¤ï¼š
GET    /api/v1/students/search?name=å¼ ä¸‰&major=è®¡ç®—æœº
GET    /api/v1/students?page=1&page_size=10

çŠ¶æ€æ“ä½œï¼š
PUT    /api/v1/students/:id/activate    # æ¿€æ´»å­¦ç”Ÿ
PUT    /api/v1/students/:id/deactivate  # ç¦ç”¨å­¦ç”Ÿ

æ‰¹é‡æ“ä½œï¼š
POST   /api/v1/students/batch           # æ‰¹é‡åˆ›å»º
DELETE /api/v1/students/batch          # æ‰¹é‡åˆ é™¤

ç»Ÿè®¡ä¿¡æ¯ï¼š
GET    /api/v1/students/statistics      # è·å–ç»Ÿè®¡ä¿¡æ¯
```

## 6.2 åŸºç¡€è·¯ç”±é…ç½®

### ä¸»è·¯ç”±æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„ï¼š** `routes/routes.go`

```go
package routes

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
    "your-project/controllers"
    "your-project/middleware"
    "your-project/models"
)

// SetupRoutes è®¾ç½®æ‰€æœ‰è·¯ç”±
func SetupRoutes(db *gorm.DB) *gin.Engine {
    // åˆ›å»ºGinå¼•æ“
    router := gin.New()
    
    // å…¨å±€ä¸­é—´ä»¶
    router.Use(middleware.Logger())
    router.Use(middleware.ErrorHandler())
    router.Use(middleware.CORS())
    
    // å¥åº·æ£€æŸ¥
    router.GET("/health", func(c *gin.Context) {
        c.JSON(http.StatusOK, gin.H{
            "status":  "ok",
            "message": "æœåŠ¡è¿è¡Œæ­£å¸¸",
        })
    })
    
    // é™æ€æ–‡ä»¶æœåŠ¡
    router.Static("/static", "./static")
    router.LoadHTMLGlob("templates/*")
    
    // åˆ›å»ºæœåŠ¡å®ä¾‹
    studentService := models.NewStudentService(db)
    
    // åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹
    studentController := controllers.NewStudentController(studentService)
    
    // è®¾ç½®APIè·¯ç”±
    setupAPIRoutes(router, studentController)
    
    // è®¾ç½®Webè·¯ç”±
    setupWebRoutes(router, studentController)
    
    return router
}

// setupAPIRoutes è®¾ç½®APIè·¯ç”±
func setupAPIRoutes(router *gin.Engine, studentController *controllers.StudentController) {
    // APIç‰ˆæœ¬åˆ†ç»„
    api := router.Group("/api")
    {
        v1 := api.Group("/v1")
        {
            // åº”ç”¨APIä¸­é—´ä»¶
            v1.Use(middleware.ValidateJSON())
            v1.Use(middleware.RateLimit(100, 200)) // æ¯ç§’100ä¸ªè¯·æ±‚ï¼Œçªå‘200ä¸ª
            
            // å­¦ç”Ÿç›¸å…³è·¯ç”±
            setupStudentRoutes(v1, studentController)
            
            // å…¶ä»–èµ„æºè·¯ç”±å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
            // setupCourseRoutes(v1, courseController)
            // setupTeacherRoutes(v1, teacherController)
        }
    }
}

// setupWebRoutes è®¾ç½®Webé¡µé¢è·¯ç”±
func setupWebRoutes(router *gin.Engine, studentController *controllers.StudentController) {
    // é¦–é¡µ
    router.GET("/", func(c *gin.Context) {
        c.HTML(http.StatusOK, "index.html", gin.H{
            "title": "å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ",
        })
    })
    
    // å­¦ç”Ÿç®¡ç†é¡µé¢
    router.GET("/students", func(c *gin.Context) {
        c.HTML(http.StatusOK, "students.html", gin.H{
            "title": "å­¦ç”Ÿç®¡ç†",
        })
    })
    
    // APIæ–‡æ¡£é¡µé¢
    router.GET("/docs", func(c *gin.Context) {
        c.HTML(http.StatusOK, "docs.html", gin.H{
            "title": "APIæ–‡æ¡£",
        })
    })
}
```

### å­¦ç”Ÿè·¯ç”±é…ç½®

**æ–‡ä»¶è·¯å¾„ï¼š** `routes/student_routes.go`

```go
package routes

import (
    "github.com/gin-gonic/gin"
    "your-project/controllers"
    "your-project/middleware"
)

// setupStudentRoutes è®¾ç½®å­¦ç”Ÿç›¸å…³è·¯ç”±
func setupStudentRoutes(rg *gin.RouterGroup, controller *controllers.StudentController) {
    students := rg.Group("/students")
    {
        // åŸºç¡€CRUDæ“ä½œ
        students.POST("", controller.CreateStudent)                    // åˆ›å»ºå­¦ç”Ÿ
        students.GET("", controller.GetAllStudents)                    // è·å–å­¦ç”Ÿåˆ—è¡¨
        students.GET("/:id", middleware.ValidateStudentID(), controller.GetStudentByID) // è·å–å•ä¸ªå­¦ç”Ÿ
        students.PUT("/:id", middleware.ValidateStudentID(), controller.UpdateStudent)  // æ›´æ–°å­¦ç”Ÿ
        students.DELETE("/:id", middleware.ValidateStudentID(), controller.DeleteStudent) // åˆ é™¤å­¦ç”Ÿ
        
        // æœç´¢åŠŸèƒ½
        students.GET("/search", controller.SearchStudents)            // æœç´¢å­¦ç”Ÿ
        
        // ç»Ÿè®¡ä¿¡æ¯
        students.GET("/statistics", controller.GetStatistics)         // è·å–ç»Ÿè®¡ä¿¡æ¯
        
        // æ‰¹é‡æ“ä½œ
        batch := students.Group("/batch")
        {
            batch.POST("", controller.BatchCreateStudents)            // æ‰¹é‡åˆ›å»º
            batch.DELETE("", controller.BatchDeleteStudents)          // æ‰¹é‡åˆ é™¤
        }
        
        // çŠ¶æ€ç®¡ç†
        status := students.Group("/:id", middleware.ValidateStudentID())
        {
            status.PUT("/activate", controller.ActivateStudent)        // æ¿€æ´»å­¦ç”Ÿ
            status.PUT("/deactivate", controller.DeactivateStudent)    // ç¦ç”¨å­¦ç”Ÿ
        }
        
        // å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
        students.POST("/import", controller.ImportStudents)           // å¯¼å…¥å­¦ç”Ÿæ•°æ®
        students.GET("/export", controller.ExportStudents)            // å¯¼å‡ºå­¦ç”Ÿæ•°æ®
        
        // é«˜çº§æŸ¥è¯¢
        advanced := students.Group("/advanced")
        {
            advanced.POST("/query", controller.AdvancedQuery)          // é«˜çº§æŸ¥è¯¢
            advanced.GET("/report", controller.GenerateReport)         // ç”ŸæˆæŠ¥å‘Š
        }
    }
}
```

## 6.3 è·¯ç”±åˆ†ç»„å’Œç‰ˆæœ¬æ§åˆ¶

### APIç‰ˆæœ¬ç®¡ç†

```go
// ç‰ˆæœ¬1 API
v1 := api.Group("/v1")
{
    v1.Use(middleware.APIVersionMiddleware("v1"))
    setupV1Routes(v1)
}

// ç‰ˆæœ¬2 APIï¼ˆå‘åå…¼å®¹ï¼‰
v2 := api.Group("/v2")
{
    v2.Use(middleware.APIVersionMiddleware("v2"))
    setupV2Routes(v2)
}

// é»˜è®¤ç‰ˆæœ¬ï¼ˆæŒ‡å‘æœ€æ–°ç‰ˆæœ¬ï¼‰
api.Use(middleware.DefaultVersionMiddleware("v2"))
setupDefaultRoutes(api)
```

### åŠŸèƒ½æ¨¡å—åˆ†ç»„

**æ–‡ä»¶è·¯å¾„ï¼š** `routes/module_routes.go`

```go
package routes

import (
    "github.com/gin-gonic/gin"
    "your-project/controllers"
)

// SetupModuleRoutes è®¾ç½®æ¨¡å—åŒ–è·¯ç”±
func SetupModuleRoutes(api *gin.RouterGroup, controllers *controllers.Controllers) {
    // ç”¨æˆ·ç®¡ç†æ¨¡å—
    userModule := api.Group("/users")
    {
        userModule.Use(middleware.AuthRequired())
        setupUserRoutes(userModule, controllers.UserController)
    }
    
    // å­¦ç”Ÿç®¡ç†æ¨¡å—
    studentModule := api.Group("/students")
    {
        studentModule.Use(middleware.PermissionRequired("student:read"))
        setupStudentRoutes(studentModule, controllers.StudentController)
    }
    
    // è¯¾ç¨‹ç®¡ç†æ¨¡å—
    courseModule := api.Group("/courses")
    {
        courseModule.Use(middleware.PermissionRequired("course:read"))
        setupCourseRoutes(courseModule, controllers.CourseController)
    }
    
    // ç³»ç»Ÿç®¡ç†æ¨¡å—
    systemModule := api.Group("/system")
    {
        systemModule.Use(middleware.AdminRequired())
        setupSystemRoutes(systemModule, controllers.SystemController)
    }
}
```

### æƒé™æ§åˆ¶è·¯ç”±

```go
// å…¬å¼€è·¯ç”±ï¼ˆæ— éœ€è®¤è¯ï¼‰
public := api.Group("/public")
{
    public.POST("/login", authController.Login)
    public.POST("/register", authController.Register)
    public.GET("/captcha", authController.GetCaptcha)
}

// éœ€è¦è®¤è¯çš„è·¯ç”±
protected := api.Group("/")
protected.Use(middleware.AuthRequired())
{
    // æ™®é€šç”¨æˆ·æƒé™
    user := protected.Group("/user")
    {
        user.GET("/profile", userController.GetProfile)
        user.PUT("/profile", userController.UpdateProfile)
    }
    
    // ç®¡ç†å‘˜æƒé™
    admin := protected.Group("/admin")
    admin.Use(middleware.AdminRequired())
    {
        admin.GET("/users", userController.GetAllUsers)
        admin.DELETE("/users/:id", userController.DeleteUser)
    }
}
```

## 6.4 ä¸­é—´ä»¶åº”ç”¨

### å…¨å±€ä¸­é—´ä»¶

**æ–‡ä»¶è·¯å¾„ï¼š** `middleware/global.go`

```go
package middleware

import (
    "time"
    
    "github.com/gin-contrib/cors"
    "github.com/gin-gonic/gin"
)

// SetupGlobalMiddleware è®¾ç½®å…¨å±€ä¸­é—´ä»¶
func SetupGlobalMiddleware(router *gin.Engine) {
    // æ¢å¤ä¸­é—´ä»¶
    router.Use(gin.Recovery())
    
    // æ—¥å¿—ä¸­é—´ä»¶
    router.Use(Logger())
    
    // CORSä¸­é—´ä»¶
    router.Use(CORS())
    
    // å®‰å…¨å¤´ä¸­é—´ä»¶
    router.Use(SecurityHeaders())
    
    // è¯·æ±‚IDä¸­é—´ä»¶
    router.Use(RequestID())
    
    // è¶…æ—¶ä¸­é—´ä»¶
    router.Use(Timeout(30 * time.Second))
}

// CORS è·¨åŸŸä¸­é—´ä»¶
func CORS() gin.HandlerFunc {
    return cors.New(cors.Config{
        AllowOrigins:     []string{"http://localhost:3000", "http://localhost:8080"},
        AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
        AllowHeaders:     []string{"Origin", "Content-Type", "Authorization", "X-Requested-With"},
        ExposeHeaders:    []string{"Content-Length", "X-Request-ID"},
        AllowCredentials: true,
        MaxAge:           12 * time.Hour,
    })
}

// SecurityHeaders å®‰å…¨å¤´ä¸­é—´ä»¶
func SecurityHeaders() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Header("X-Content-Type-Options", "nosniff")
        c.Header("X-Frame-Options", "DENY")
        c.Header("X-XSS-Protection", "1; mode=block")
        c.Header("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
        c.Next()
    }
}

// RequestID è¯·æ±‚IDä¸­é—´ä»¶
func RequestID() gin.HandlerFunc {
    return func(c *gin.Context) {
        requestID := c.GetHeader("X-Request-ID")
        if requestID == "" {
            requestID = generateRequestID()
        }
        c.Set("request_id", requestID)
        c.Header("X-Request-ID", requestID)
        c.Next()
    }
}

// Timeout è¶…æ—¶ä¸­é—´ä»¶
func Timeout(timeout time.Duration) gin.HandlerFunc {
    return func(c *gin.Context) {
        ctx, cancel := context.WithTimeout(c.Request.Context(), timeout)
        defer cancel()
        
        c.Request = c.Request.WithContext(ctx)
        
        finished := make(chan struct{})
        go func() {
            c.Next()
            finished <- struct{}{}
        }()
        
        select {
        case <-finished:
            return
        case <-ctx.Done():
            c.JSON(http.StatusRequestTimeout, gin.H{
                "error": "è¯·æ±‚è¶…æ—¶",
            })
            c.Abort()
        }
    }
}
```

### è·¯ç”±çº§ä¸­é—´ä»¶

```go
// ä¸ºç‰¹å®šè·¯ç”±ç»„åº”ç”¨ä¸­é—´ä»¶
api := router.Group("/api")
api.Use(middleware.RateLimit(100, 200))
api.Use(middleware.ValidateJSON())
{
    v1 := api.Group("/v1")
    v1.Use(middleware.APIVersionMiddleware("v1"))
    {
        // å­¦ç”Ÿè·¯ç”±
        students := v1.Group("/students")
        students.Use(middleware.CacheMiddleware(5 * time.Minute)) // ç¼“å­˜5åˆ†é’Ÿ
        {
            students.GET("", controller.GetAllStudents)
            students.GET("/:id", middleware.ValidateStudentID(), controller.GetStudentByID)
        }
    }
}
```

## 6.5 å‚æ•°å¤„ç†

### è·¯å¾„å‚æ•°

```go
// è·¯å¾„å‚æ•°æå–
router.GET("/students/:id", func(c *gin.Context) {
    id := c.Param("id")
    // éªŒè¯å’Œè½¬æ¢
    studentID, err := strconv.ParseUint(id, 10, 32)
    if err != nil {
        c.JSON(400, gin.H{"error": "æ— æ•ˆçš„å­¦ç”ŸID"})
        return
    }
    // å¤„ç†é€»è¾‘...
})

// å¤šä¸ªè·¯å¾„å‚æ•°
router.GET("/students/:id/courses/:courseId", func(c *gin.Context) {
    studentID := c.Param("id")
    courseID := c.Param("courseId")
    // å¤„ç†é€»è¾‘...
})

// é€šé…ç¬¦å‚æ•°
router.GET("/files/*filepath", func(c *gin.Context) {
    filepath := c.Param("filepath")
    // å¤„ç†æ–‡ä»¶è·¯å¾„...
})
```

### æŸ¥è¯¢å‚æ•°

```go
// æŸ¥è¯¢å‚æ•°å¤„ç†
router.GET("/students", func(c *gin.Context) {
    // åŸºç¡€æŸ¥è¯¢å‚æ•°
    name := c.Query("name")
    major := c.Query("major")
    
    // å¸¦é»˜è®¤å€¼çš„æŸ¥è¯¢å‚æ•°
    page := c.DefaultQuery("page", "1")
    pageSize := c.DefaultQuery("page_size", "10")
    
    // æ•°ç»„æŸ¥è¯¢å‚æ•°
    grades := c.QueryArray("grade")
    
    // æŸ¥è¯¢å‚æ•°æ˜ å°„
    filters := c.QueryMap("filter")
    
    // å¤„ç†é€»è¾‘...
})
```

### è¯·æ±‚ä½“å‚æ•°

```go
// JSONç»‘å®š
router.POST("/students", func(c *gin.Context) {
    var student models.CreateStudentRequest
    
    // ç»‘å®šJSON
    if err := c.ShouldBindJSON(&student); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }
    
    // å¤„ç†é€»è¾‘...
})

// è¡¨å•ç»‘å®š
router.POST("/upload", func(c *gin.Context) {
    var form struct {
        Name string `form:"name" binding:"required"`
        File *multipart.FileHeader `form:"file" binding:"required"`
    }
    
    if err := c.ShouldBind(&form); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ ...
})
```

## 6.6 é”™è¯¯å¤„ç†è·¯ç”±

### 404å¤„ç†

```go
// 404é”™è¯¯å¤„ç†
router.NoRoute(func(c *gin.Context) {
    // APIè¯·æ±‚è¿”å›JSON
    if strings.HasPrefix(c.Request.URL.Path, "/api/") {
        c.JSON(http.StatusNotFound, gin.H{
            "success": false,
            "message": "APIç«¯ç‚¹ä¸å­˜åœ¨",
            "error":   "è·¯ç”±æœªæ‰¾åˆ°",
        })
        return
    }
    
    // Webè¯·æ±‚è¿”å›HTMLé¡µé¢
    c.HTML(http.StatusNotFound, "404.html", gin.H{
        "title": "é¡µé¢æœªæ‰¾åˆ°",
        "path":  c.Request.URL.Path,
    })
})
```

### 405å¤„ç†

```go
// 405é”™è¯¯å¤„ç†
router.NoMethod(func(c *gin.Context) {
    c.JSON(http.StatusMethodNotAllowed, gin.H{
        "success": false,
        "message": "HTTPæ–¹æ³•ä¸è¢«å…è®¸",
        "error":   fmt.Sprintf("æ–¹æ³• %s ä¸è¢«å…è®¸", c.Request.Method),
    })
})
```

## 6.7 APIæ–‡æ¡£é›†æˆ

### Swaggeré›†æˆ

**å®‰è£…ä¾èµ–ï¼š**
```bash
go get github.com/swaggo/gin-swagger
go get github.com/swaggo/files
go get github.com/swaggo/swag/cmd/swag
```

**æ–‡æ¡£æ³¨é‡Šç¤ºä¾‹ï¼š**
```go
// @title å­¦ç”Ÿç®¡ç†ç³»ç»ŸAPI
// @version 1.0
// @description è¿™æ˜¯ä¸€ä¸ªå­¦ç”Ÿç®¡ç†ç³»ç»Ÿçš„APIæ–‡æ¡£
// @termsOfService http://swagger.io/terms/

// @contact.name APIæ”¯æŒ
// @contact.url http://www.swagger.io/support
// @contact.email support@swagger.io

// @license.name MIT
// @license.url https://opensource.org/licenses/MIT

// @host localhost:8080
// @BasePath /api/v1

// @securityDefinitions.apikey ApiKeyAuth
// @in header
// @name Authorization

package main

// CreateStudent åˆ›å»ºå­¦ç”Ÿ
// @Summary åˆ›å»ºå­¦ç”Ÿ
// @Description åˆ›å»ºæ–°çš„å­¦ç”Ÿè®°å½•
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param student body models.CreateStudentRequest true "å­¦ç”Ÿä¿¡æ¯"
// @Success 201 {object} utils.Response{data=models.StudentResponse}
// @Failure 400 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /students [post]
func (sc *StudentController) CreateStudent(c *gin.Context) {
    // å®ç°ä»£ç ...
}
```

**è·¯ç”±é›†æˆï¼š**
```go
import (
    "github.com/swaggo/gin-swagger"
    "github.com/swaggo/files"
    _ "your-project/docs" // å¯¼å…¥ç”Ÿæˆçš„æ–‡æ¡£
)

// æ·»åŠ Swaggerè·¯ç”±
router.GET("/swagger/*any", ginSwagger.WrapHandler(swaggerFiles.Handler))
```

### è‡ªå®šä¹‰APIæ–‡æ¡£

**æ–‡ä»¶è·¯å¾„ï¼š** `routes/docs_routes.go`

```go
package routes

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
)

// setupDocsRoutes è®¾ç½®æ–‡æ¡£è·¯ç”±
func setupDocsRoutes(router *gin.Engine) {
    docs := router.Group("/docs")
    {
        // APIæ–‡æ¡£é¦–é¡µ
        docs.GET("/", func(c *gin.Context) {
            c.HTML(http.StatusOK, "docs/index.html", gin.H{
                "title": "APIæ–‡æ¡£",
            })
        })
        
        // APIè§„èŒƒ
        docs.GET("/api-spec", func(c *gin.Context) {
            c.JSON(http.StatusOK, getAPISpecification())
        })
        
        // ç¤ºä¾‹ä»£ç 
        docs.GET("/examples", func(c *gin.Context) {
            c.HTML(http.StatusOK, "docs/examples.html", gin.H{
                "title": "APIç¤ºä¾‹",
                "examples": getAPIExamples(),
            })
        })
        
        // å˜æ›´æ—¥å¿—
        docs.GET("/changelog", func(c *gin.Context) {
            c.HTML(http.StatusOK, "docs/changelog.html", gin.H{
                "title": "å˜æ›´æ—¥å¿—",
                "changes": getChangeLog(),
            })
        })
    }
}

// getAPISpecification è·å–APIè§„èŒƒ
func getAPISpecification() map[string]interface{} {
    return map[string]interface{}{
        "openapi": "3.0.0",
        "info": map[string]interface{}{
            "title":       "å­¦ç”Ÿç®¡ç†ç³»ç»ŸAPI",
            "version":     "1.0.0",
            "description": "å­¦ç”Ÿç®¡ç†ç³»ç»Ÿçš„RESTful API",
        },
        "servers": []map[string]interface{}{
            {
                "url":         "http://localhost:8080/api/v1",
                "description": "å¼€å‘æœåŠ¡å™¨",
            },
        },
        "paths": getAPIPaths(),
        "components": getAPIComponents(),
    }
}
```

## 6.8 è·¯ç”±æµ‹è¯•

### è·¯ç”±å•å…ƒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„ï¼š** `routes/routes_test.go`

```go
package routes

import (
    "net/http"
    "net/http/httptest"
    "testing"
    
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    "your-project/models"
)

func TestSetupRoutes(t *testing.T) {
    // è®¾ç½®æµ‹è¯•æ¨¡å¼
    gin.SetMode(gin.TestMode)
    
    // åˆ›å»ºæµ‹è¯•æ•°æ®åº“
    db := setupTestDB()
    
    // è®¾ç½®è·¯ç”±
    router := SetupRoutes(db)
    
    // æµ‹è¯•å¥åº·æ£€æŸ¥
    req, _ := http.NewRequest("GET", "/health", nil)
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    assert.Contains(t, w.Body.String(), "æœåŠ¡è¿è¡Œæ­£å¸¸")
}

func TestStudentRoutes(t *testing.T) {
    gin.SetMode(gin.TestMode)
    db := setupTestDB()
    router := SetupRoutes(db)
    
    tests := []struct {
        name           string
        method         string
        url            string
        expectedStatus int
    }{
        {"è·å–å­¦ç”Ÿåˆ—è¡¨", "GET", "/api/v1/students", http.StatusOK},
        {"è·å–ä¸å­˜åœ¨çš„å­¦ç”Ÿ", "GET", "/api/v1/students/999", http.StatusNotFound},
        {"æ— æ•ˆçš„å­¦ç”ŸID", "GET", "/api/v1/students/abc", http.StatusBadRequest},
        {"æœç´¢å­¦ç”Ÿ", "GET", "/api/v1/students/search?name=å¼ ä¸‰", http.StatusOK},
        {"è·å–ç»Ÿè®¡ä¿¡æ¯", "GET", "/api/v1/students/statistics", http.StatusOK},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            req, _ := http.NewRequest(tt.method, tt.url, nil)
            w := httptest.NewRecorder()
            router.ServeHTTP(w, req)
            
            assert.Equal(t, tt.expectedStatus, w.Code)
        })
    }
}

func TestAPIVersioning(t *testing.T) {
    gin.SetMode(gin.TestMode)
    db := setupTestDB()
    router := SetupRoutes(db)
    
    // æµ‹è¯•v1 API
    req, _ := http.NewRequest("GET", "/api/v1/students", nil)
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // æµ‹è¯•ä¸å­˜åœ¨çš„ç‰ˆæœ¬
    req, _ = http.NewRequest("GET", "/api/v3/students", nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusNotFound, w.Code)
}

func TestMiddlewareApplication(t *testing.T) {
    gin.SetMode(gin.TestMode)
    db := setupTestDB()
    router := SetupRoutes(db)
    
    // æµ‹è¯•CORSå¤´
    req, _ := http.NewRequest("OPTIONS", "/api/v1/students", nil)
    req.Header.Set("Origin", "http://localhost:3000")
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusNoContent, w.Code)
    assert.Equal(t, "http://localhost:3000", w.Header().Get("Access-Control-Allow-Origin"))
    
    // æµ‹è¯•è¯·æ±‚ID
    req, _ = http.NewRequest("GET", "/api/v1/students", nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.NotEmpty(t, w.Header().Get("X-Request-ID"))
}
```

### é›†æˆæµ‹è¯•

```go
func TestFullAPIWorkflow(t *testing.T) {
    gin.SetMode(gin.TestMode)
    db := setupTestDB()
    router := SetupRoutes(db)
    
    // 1. åˆ›å»ºå­¦ç”Ÿ
    createData := `{
        "name": "æµ‹è¯•å­¦ç”Ÿ",
        "age": 20,
        "gender": "ç”·",
        "email": "test@example.com",
        "major": "è®¡ç®—æœºç§‘å­¦",
        "grade": "2023"
    }`
    
    req, _ := http.NewRequest("POST", "/api/v1/students", strings.NewReader(createData))
    req.Header.Set("Content-Type", "application/json")
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusCreated, w.Code)
    
    // è§£æå“åº”è·å–å­¦ç”ŸID
    var createResponse map[string]interface{}
    json.Unmarshal(w.Body.Bytes(), &createResponse)
    data := createResponse["data"].(map[string]interface{})
    studentID := int(data["id"].(float64))
    
    // 2. è·å–å­¦ç”Ÿ
    req, _ = http.NewRequest("GET", fmt.Sprintf("/api/v1/students/%d", studentID), nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // 3. æ›´æ–°å­¦ç”Ÿ
    updateData := `{"age": 21}`
    req, _ = http.NewRequest("PUT", fmt.Sprintf("/api/v1/students/%d", studentID), strings.NewReader(updateData))
    req.Header.Set("Content-Type", "application/json")
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // 4. æœç´¢å­¦ç”Ÿ
    req, _ = http.NewRequest("GET", "/api/v1/students/search?name=æµ‹è¯•", nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // 5. åˆ é™¤å­¦ç”Ÿ
    req, _ = http.NewRequest("DELETE", fmt.Sprintf("/api/v1/students/%d", studentID), nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // 6. éªŒè¯åˆ é™¤
    req, _ = http.NewRequest("GET", fmt.Sprintf("/api/v1/students/%d", studentID), nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusNotFound, w.Code)
}
```

## 6.9 æ€§èƒ½ä¼˜åŒ–

### è·¯ç”±ç¼“å­˜

```go
// è·¯ç”±çº§ç¼“å­˜
students.GET("", middleware.CacheMiddleware(5*time.Minute), controller.GetAllStudents)
students.GET("/:id", middleware.CacheMiddleware(10*time.Minute), controller.GetStudentByID)

// æ¡ä»¶ç¼“å­˜
students.GET("/search", middleware.ConditionalCache(func(c *gin.Context) bool {
    // åªç¼“å­˜æ²¡æœ‰å¤æ‚æŸ¥è¯¢å‚æ•°çš„æœç´¢
    return len(c.Request.URL.Query()) <= 2
}, 3*time.Minute), controller.SearchStudents)
```

### è·¯ç”±å‹ç¼©

```go
import "github.com/gin-contrib/gzip"

// å¯ç”¨Gzipå‹ç¼©
router.Use(gzip.Gzip(gzip.DefaultCompression))

// æˆ–è€…é€‰æ‹©æ€§å‹ç¼©
api.Use(gzip.Gzip(gzip.DefaultCompression, gzip.WithExcludedPaths([]string{
    "/api/v1/upload",
    "/api/v1/download",
})))
```

### è·¯ç”±é¢„ç¼–è¯‘

```go
// é¢„ç¼–è¯‘è·¯ç”±æ¨¡å¼
func precompileRoutes() {
    // é¢„ç¼–è¯‘å¸¸ç”¨çš„è·¯ç”±æ¨¡å¼
    studentIDPattern := regexp.MustCompile(`^/api/v1/students/\d+$`)
    searchPattern := regexp.MustCompile(`^/api/v1/students/search`)
    
    // åœ¨ä¸­é—´ä»¶ä¸­ä½¿ç”¨é¢„ç¼–è¯‘çš„æ¨¡å¼
    router.Use(func(c *gin.Context) {
        path := c.Request.URL.Path
        
        if studentIDPattern.MatchString(path) {
            c.Set("route_type", "student_detail")
        } else if searchPattern.MatchString(path) {
            c.Set("route_type", "student_search")
        }
        
        c.Next()
    })
}
```

## 6.10 ä¸‹ä¸€æ­¥

è·¯ç”±é…ç½®å®Œæˆåï¼Œä½ åº”è¯¥æŒæ¡ï¼š
- âœ… RESTful APIè®¾è®¡åŸåˆ™
- âœ… è·¯ç”±åˆ†ç»„å’Œç‰ˆæœ¬æ§åˆ¶
- âœ… ä¸­é—´ä»¶çš„åº”ç”¨å’Œé…ç½®
- âœ… å‚æ•°å¤„ç†å’ŒéªŒè¯
- âœ… é”™è¯¯å¤„ç†å’ŒAPIæ–‡æ¡£
- âœ… è·¯ç”±æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨[ç¬¬7ç« ï¼šå‰ç«¯ç•Œé¢å¼€å‘](./07-å‰ç«¯ç•Œé¢å¼€å‘.md)ä¸­å­¦ä¹ å¦‚ä½•å¼€å‘ç”¨æˆ·ç•Œé¢ã€‚

## å‚è€ƒèµ„æº

- [Ginè·¯ç”±æ–‡æ¡£](https://gin-gonic.com/docs/examples/)
- [RESTful APIè®¾è®¡æŒ‡å—](https://restfulapi.net/)
- [Swagger/OpenAPIè§„èŒƒ](https://swagger.io/specification/)
- [HTTPçŠ¶æ€ç å‚è€ƒ](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)