# ç¬¬4ç« ï¼šæ¨¡å‹å±‚å¼€å‘

æœ¬ç« å°†æ·±å…¥å­¦ä¹ æ¨¡å‹å±‚çš„å¼€å‘ï¼ŒåŒ…æ‹¬æ•°æ®æ¨¡å‹å®šä¹‰ã€éªŒè¯è§„åˆ™ã€ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æ“ä½œå°è£…ã€‚

## 4.1 æ¨¡å‹å±‚èŒè´£

æ¨¡å‹å±‚ï¼ˆModelï¼‰åœ¨MVCæ¶æ„ä¸­æ‰¿æ‹…ä»¥ä¸‹èŒè´£ï¼š

- ğŸ“Š **æ•°æ®ç»“æ„å®šä¹‰**ï¼šå®šä¹‰åº”ç”¨ç¨‹åºçš„æ•°æ®ç»“æ„
- âœ… **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œæœ‰æ•ˆæ€§
- ğŸ”§ **ä¸šåŠ¡é€»è¾‘**ï¼šå°è£…æ ¸å¿ƒä¸šåŠ¡è§„åˆ™
- ğŸ’¾ **æ•°æ®æŒä¹…åŒ–**ï¼šå¤„ç†æ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢
- ğŸ”„ **æ•°æ®è½¬æ¢**ï¼šå¤„ç†ä¸åŒæ ¼å¼é—´çš„æ•°æ®è½¬æ¢

## 4.2 å­¦ç”Ÿæ¨¡å‹å®Œæ•´å®ç°

### åŸºç¡€æ¨¡å‹å®šä¹‰

**æ–‡ä»¶è·¯å¾„ï¼š** `models/student.go`

```go
package models

import (
    "errors"
    "regexp"
    "strings"
    "time"
    
    "github.com/go-playground/validator/v10"
    "gorm.io/gorm"
)

// Student å­¦ç”Ÿæ¨¡å‹
type Student struct {
    // åŸºç¡€å­—æ®µï¼ˆGORMè‡ªåŠ¨ç®¡ç†ï¼‰
    ID        uint           `json:"id" gorm:"primaryKey"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `json:"-" gorm:"index"`
    
    // å­¦ç”ŸåŸºæœ¬ä¿¡æ¯
    Name   string `json:"name" gorm:"not null;size:50;comment:å­¦ç”Ÿå§“å" validate:"required,min=2,max=50,chinese_name"`
    Age    int    `json:"age" gorm:"not null;comment:å¹´é¾„" validate:"required,min=1,max=150"`
    Gender string `json:"gender" gorm:"not null;size:10;comment:æ€§åˆ«" validate:"required,oneof=ç”· å¥³"`
    
    // è”ç³»ä¿¡æ¯
    Email string `json:"email" gorm:"unique;not null;size:100;comment:é‚®ç®±" validate:"required,email"`
    Phone string `json:"phone" gorm:"size:20;comment:ç”µè¯å·ç " validate:"omitempty,chinese_phone"`
    
    // å­¦æœ¯ä¿¡æ¯
    Major      string `json:"major" gorm:"size:50;comment:ä¸“ä¸š" validate:"omitempty,max=50"`
    Grade      string `json:"grade" gorm:"size:20;comment:å¹´çº§" validate:"omitempty,max=20"`
    StudentID  string `json:"student_id" gorm:"unique;size:20;comment:å­¦å·" validate:"omitempty,student_id"`
    
    // æ‰©å±•ä¿¡æ¯
    Avatar      string `json:"avatar" gorm:"size:255;comment:å¤´åƒURL" validate:"omitempty,url"`
    Address     string `json:"address" gorm:"size:200;comment:åœ°å€" validate:"omitempty,max=200"`
    Description string `json:"description" gorm:"type:text;comment:å¤‡æ³¨" validate:"omitempty,max=500"`
    Status      int    `json:"status" gorm:"default:1;comment:çŠ¶æ€(1:æ­£å¸¸,0:ç¦ç”¨)" validate:"omitempty,oneof=0 1"`
}

// TableName æŒ‡å®šè¡¨å
func (Student) TableName() string {
    return "students"
}
```

### è‡ªå®šä¹‰éªŒè¯å™¨

```go
// éªŒè¯å™¨å®ä¾‹
var validate *validator.Validate

// åˆå§‹åŒ–éªŒè¯å™¨
func init() {
    validate = validator.New()
    
    // æ³¨å†Œè‡ªå®šä¹‰éªŒè¯å™¨
    validate.RegisterValidation("chinese_name", validateChineseName)
    validate.RegisterValidation("chinese_phone", validateChinesePhone)
    validate.RegisterValidation("student_id", validateStudentID)
}

// éªŒè¯ä¸­æ–‡å§“å
func validateChineseName(fl validator.FieldLevel) bool {
    name := fl.Field().String()
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
    chineseRegex := regexp.MustCompile(`[\p{Han}]+`)
    if !chineseRegex.MatchString(name) {
        return false
    }
    
    // æ£€æŸ¥é•¿åº¦ï¼ˆä¸­æ–‡å­—ç¬¦æŒ‰2ä¸ªå­—ç¬¦è®¡ç®—ï¼‰
    if len([]rune(name)) < 2 || len([]rune(name)) > 10 {
        return false
    }
    
    return true
}

// éªŒè¯ä¸­å›½æ‰‹æœºå·
func validateChinesePhone(fl validator.FieldLevel) bool {
    phone := fl.Field().String()
    
    // ä¸­å›½æ‰‹æœºå·æ­£åˆ™è¡¨è¾¾å¼
    phoneRegex := regexp.MustCompile(`^1[3-9]\d{9}$`)
    return phoneRegex.MatchString(phone)
}

// éªŒè¯å­¦å·æ ¼å¼
func validateStudentID(fl validator.FieldLevel) bool {
    studentID := fl.Field().String()
    
    // å­¦å·æ ¼å¼ï¼šå¹´ä»½(4ä½) + ä¸“ä¸šä»£ç (2ä½) + åºå·(4ä½)
    // ä¾‹å¦‚ï¼š20230101
    studentIDRegex := regexp.MustCompile(`^20\d{2}\d{2}\d{4}$`)
    return studentIDRegex.MatchString(studentID)
}
```

### æ¨¡å‹æ–¹æ³•

```go
// Validate éªŒè¯å­¦ç”Ÿæ•°æ®
func (s *Student) Validate() error {
    return validate.Struct(s)
}

// BeforeCreate GORMé’©å­ï¼šåˆ›å»ºå‰
func (s *Student) BeforeCreate(tx *gorm.DB) error {
    // æ•°æ®æ¸…ç†
    s.Name = strings.TrimSpace(s.Name)
    s.Email = strings.ToLower(strings.TrimSpace(s.Email))
    s.Phone = strings.TrimSpace(s.Phone)
    
    // éªŒè¯æ•°æ®
    if err := s.Validate(); err != nil {
        return err
    }
    
    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    var count int64
    tx.Model(&Student{}).Where("email = ?", s.Email).Count(&count)
    if count > 0 {
        return errors.New("é‚®ç®±å·²å­˜åœ¨")
    }
    
    // ç”Ÿæˆå­¦å·ï¼ˆå¦‚æœæœªæä¾›ï¼‰
    if s.StudentID == "" {
        s.StudentID = s.generateStudentID(tx)
    }
    
    return nil
}

// BeforeUpdate GORMé’©å­ï¼šæ›´æ–°å‰
func (s *Student) BeforeUpdate(tx *gorm.DB) error {
    // æ•°æ®æ¸…ç†
    s.Name = strings.TrimSpace(s.Name)
    s.Email = strings.ToLower(strings.TrimSpace(s.Email))
    s.Phone = strings.TrimSpace(s.Phone)
    
    // éªŒè¯æ•°æ®
    if err := s.Validate(); err != nil {
        return err
    }
    
    // æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§ï¼ˆæ’é™¤è‡ªå·±ï¼‰
    var count int64
    tx.Model(&Student{}).Where("email = ? AND id != ?", s.Email, s.ID).Count(&count)
    if count > 0 {
        return errors.New("é‚®ç®±å·²å­˜åœ¨")
    }
    
    return nil
}

// generateStudentID ç”Ÿæˆå­¦å·
func (s *Student) generateStudentID(tx *gorm.DB) string {
    year := time.Now().Year()
    
    // è·å–ä¸“ä¸šä»£ç ï¼ˆç®€åŒ–å¤„ç†ï¼‰
    majorCode := "01" // é»˜è®¤ä¸“ä¸šä»£ç 
    if s.Major != "" {
        majorCode = s.getMajorCode(s.Major)
    }
    
    // è·å–å½“å¹´è¯¥ä¸“ä¸šçš„æœ€å¤§åºå·
    var maxID string
    prefix := fmt.Sprintf("%d%s", year, majorCode)
    tx.Model(&Student{}).
        Where("student_id LIKE ?", prefix+"%").
        Order("student_id DESC").
        Limit(1).
        Pluck("student_id", &maxID)
    
    // è®¡ç®—æ–°åºå·
    sequence := 1
    if maxID != "" && len(maxID) >= 8 {
        if seq, err := strconv.Atoi(maxID[6:]); err == nil {
            sequence = seq + 1
        }
    }
    
    return fmt.Sprintf("%s%04d", prefix, sequence)
}

// getMajorCode è·å–ä¸“ä¸šä»£ç 
func (s *Student) getMajorCode(major string) string {
    majorCodes := map[string]string{
        "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯": "01",
        "è½¯ä»¶å·¥ç¨‹":     "02",
        "ç½‘ç»œå·¥ç¨‹":     "03",
        "ä¿¡æ¯å®‰å…¨":     "04",
        "æ•°æ®ç§‘å­¦":     "05",
    }
    
    if code, exists := majorCodes[major]; exists {
        return code
    }
    return "99" // å…¶ä»–ä¸“ä¸š
}

// GetAge è®¡ç®—å¹´é¾„ï¼ˆå¦‚æœéœ€è¦æ ¹æ®ç”Ÿæ—¥è®¡ç®—ï¼‰
func (s *Student) GetAge() int {
    return s.Age
}

// GetDisplayName è·å–æ˜¾ç¤ºåç§°
func (s *Student) GetDisplayName() string {
    if s.StudentID != "" {
        return fmt.Sprintf("%s (%s)", s.Name, s.StudentID)
    }
    return s.Name
}

// IsActive æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦æ¿€æ´»
func (s *Student) IsActive() bool {
    return s.Status == 1
}

// GetGradeYear è·å–å¹´çº§å¹´ä»½
func (s *Student) GetGradeYear() int {
    if s.Grade == "" {
        return 0
    }
    
    // ä»å¹´çº§å­—ç¬¦ä¸²ä¸­æå–å¹´ä»½ï¼Œå¦‚"2023çº§" -> 2023
    re := regexp.MustCompile(`(\d{4})`)
    matches := re.FindStringSubmatch(s.Grade)
    if len(matches) > 1 {
        if year, err := strconv.Atoi(matches[1]); err == nil {
            return year
        }
    }
    
    return 0
}
```

## 4.3 æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰

### è¯·æ±‚DTO

```go
// CreateStudentRequest åˆ›å»ºå­¦ç”Ÿè¯·æ±‚
type CreateStudentRequest struct {
    Name        string `json:"name" validate:"required,min=2,max=50"`
    Age         int    `json:"age" validate:"required,min=1,max=150"`
    Gender      string `json:"gender" validate:"required,oneof=ç”· å¥³"`
    Email       string `json:"email" validate:"required,email"`
    Phone       string `json:"phone" validate:"omitempty,chinese_phone"`
    Major       string `json:"major" validate:"omitempty,max=50"`
    Grade       string `json:"grade" validate:"omitempty,max=20"`
    Address     string `json:"address" validate:"omitempty,max=200"`
    Description string `json:"description" validate:"omitempty,max=500"`
}

// ToStudent è½¬æ¢ä¸ºStudentæ¨¡å‹
func (req *CreateStudentRequest) ToStudent() *Student {
    return &Student{
        Name:        req.Name,
        Age:         req.Age,
        Gender:      req.Gender,
        Email:       req.Email,
        Phone:       req.Phone,
        Major:       req.Major,
        Grade:       req.Grade,
        Address:     req.Address,
        Description: req.Description,
        Status:      1, // é»˜è®¤æ¿€æ´»çŠ¶æ€
    }
}

// UpdateStudentRequest æ›´æ–°å­¦ç”Ÿè¯·æ±‚
type UpdateStudentRequest struct {
    Name        *string `json:"name" validate:"omitempty,min=2,max=50"`
    Age         *int    `json:"age" validate:"omitempty,min=1,max=150"`
    Gender      *string `json:"gender" validate:"omitempty,oneof=ç”· å¥³"`
    Email       *string `json:"email" validate:"omitempty,email"`
    Phone       *string `json:"phone" validate:"omitempty,chinese_phone"`
    Major       *string `json:"major" validate:"omitempty,max=50"`
    Grade       *string `json:"grade" validate:"omitempty,max=20"`
    Address     *string `json:"address" validate:"omitempty,max=200"`
    Description *string `json:"description" validate:"omitempty,max=500"`
    Status      *int    `json:"status" validate:"omitempty,oneof=0 1"`
}

// ApplyToStudent åº”ç”¨æ›´æ–°åˆ°Studentæ¨¡å‹
func (req *UpdateStudentRequest) ApplyToStudent(student *Student) {
    if req.Name != nil {
        student.Name = *req.Name
    }
    if req.Age != nil {
        student.Age = *req.Age
    }
    if req.Gender != nil {
        student.Gender = *req.Gender
    }
    if req.Email != nil {
        student.Email = *req.Email
    }
    if req.Phone != nil {
        student.Phone = *req.Phone
    }
    if req.Major != nil {
        student.Major = *req.Major
    }
    if req.Grade != nil {
        student.Grade = *req.Grade
    }
    if req.Address != nil {
        student.Address = *req.Address
    }
    if req.Description != nil {
        student.Description = *req.Description
    }
    if req.Status != nil {
        student.Status = *req.Status
    }
}
```

### å“åº”DTO

```go
// StudentResponse å­¦ç”Ÿå“åº”
type StudentResponse struct {
    ID          uint      `json:"id"`
    Name        string    `json:"name"`
    Age         int       `json:"age"`
    Gender      string    `json:"gender"`
    Email       string    `json:"email"`
    Phone       string    `json:"phone"`
    Major       string    `json:"major"`
    Grade       string    `json:"grade"`
    StudentID   string    `json:"student_id"`
    Avatar      string    `json:"avatar"`
    Address     string    `json:"address"`
    Description string    `json:"description"`
    Status      int       `json:"status"`
    StatusText  string    `json:"status_text"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}

// FromStudent ä»Studentæ¨¡å‹åˆ›å»ºå“åº”
func (resp *StudentResponse) FromStudent(student *Student) {
    resp.ID = student.ID
    resp.Name = student.Name
    resp.Age = student.Age
    resp.Gender = student.Gender
    resp.Email = student.Email
    resp.Phone = student.Phone
    resp.Major = student.Major
    resp.Grade = student.Grade
    resp.StudentID = student.StudentID
    resp.Avatar = student.Avatar
    resp.Address = student.Address
    resp.Description = student.Description
    resp.Status = student.Status
    resp.StatusText = map[int]string{0: "ç¦ç”¨", 1: "æ­£å¸¸"}[student.Status]
    resp.CreatedAt = student.CreatedAt
    resp.UpdatedAt = student.UpdatedAt
}

// StudentListResponse å­¦ç”Ÿåˆ—è¡¨å“åº”
type StudentListResponse struct {
    Students []StudentResponse `json:"students"`
    Total    int64             `json:"total"`
    Page     int               `json:"page"`
    PageSize int               `json:"page_size"`
}
```

## 4.4 ä¸šåŠ¡é€»è¾‘å±‚

### å­¦ç”ŸæœåŠ¡

```go
package models

import (
    "errors"
    "fmt"
    
    "gorm.io/gorm"
)

// StudentService å­¦ç”Ÿä¸šåŠ¡æœåŠ¡
type StudentService struct {
    db *gorm.DB
}

// NewStudentService åˆ›å»ºå­¦ç”ŸæœåŠ¡å®ä¾‹
func NewStudentService(db *gorm.DB) *StudentService {
    return &StudentService{db: db}
}

// Create åˆ›å»ºå­¦ç”Ÿ
func (s *StudentService) Create(req *CreateStudentRequest) (*Student, error) {
    // éªŒè¯è¯·æ±‚æ•°æ®
    if err := validate.Struct(req); err != nil {
        return nil, fmt.Errorf("æ•°æ®éªŒè¯å¤±è´¥: %w", err)
    }
    
    // è½¬æ¢ä¸ºæ¨¡å‹
    student := req.ToStudent()
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    if err := s.db.Create(student).Error; err != nil {
        return nil, fmt.Errorf("åˆ›å»ºå­¦ç”Ÿå¤±è´¥: %w", err)
    }
    
    return student, nil
}

// GetByID æ ¹æ®IDè·å–å­¦ç”Ÿ
func (s *StudentService) GetByID(id uint) (*Student, error) {
    var student Student
    err := s.db.First(&student, id).Error
    if err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, errors.New("å­¦ç”Ÿä¸å­˜åœ¨")
        }
        return nil, fmt.Errorf("æŸ¥è¯¢å­¦ç”Ÿå¤±è´¥: %w", err)
    }
    return &student, nil
}

// GetAll è·å–æ‰€æœ‰å­¦ç”Ÿ
func (s *StudentService) GetAll() ([]Student, error) {
    var students []Student
    err := s.db.Where("deleted_at IS NULL").Order("created_at DESC").Find(&students).Error
    if err != nil {
        return nil, fmt.Errorf("æŸ¥è¯¢å­¦ç”Ÿåˆ—è¡¨å¤±è´¥: %w", err)
    }
    return students, nil
}

// GetWithPagination åˆ†é¡µè·å–å­¦ç”Ÿ
func (s *StudentService) GetWithPagination(page, pageSize int) ([]Student, int64, error) {
    var students []Student
    var total int64
    
    // è®¡ç®—æ€»æ•°
    if err := s.db.Model(&Student{}).Where("deleted_at IS NULL").Count(&total).Error; err != nil {
        return nil, 0, fmt.Errorf("ç»Ÿè®¡å­¦ç”Ÿæ€»æ•°å¤±è´¥: %w", err)
    }
    
    // åˆ†é¡µæŸ¥è¯¢
    offset := (page - 1) * pageSize
    err := s.db.Where("deleted_at IS NULL").
        Order("created_at DESC").
        Offset(offset).
        Limit(pageSize).
        Find(&students).Error
    
    if err != nil {
        return nil, 0, fmt.Errorf("åˆ†é¡µæŸ¥è¯¢å­¦ç”Ÿå¤±è´¥: %w", err)
    }
    
    return students, total, nil
}

// Update æ›´æ–°å­¦ç”Ÿ
func (s *StudentService) Update(id uint, req *UpdateStudentRequest) (*Student, error) {
    // éªŒè¯è¯·æ±‚æ•°æ®
    if err := validate.Struct(req); err != nil {
        return nil, fmt.Errorf("æ•°æ®éªŒè¯å¤±è´¥: %w", err)
    }
    
    // æŸ¥æ‰¾å­¦ç”Ÿ
    student, err := s.GetByID(id)
    if err != nil {
        return nil, err
    }
    
    // åº”ç”¨æ›´æ–°
    req.ApplyToStudent(student)
    
    // ä¿å­˜æ›´æ–°
    if err := s.db.Save(student).Error; err != nil {
        return nil, fmt.Errorf("æ›´æ–°å­¦ç”Ÿå¤±è´¥: %w", err)
    }
    
    return student, nil
}

// Delete åˆ é™¤å­¦ç”Ÿï¼ˆè½¯åˆ é™¤ï¼‰
func (s *StudentService) Delete(id uint) error {
    // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ¨
    if _, err := s.GetByID(id); err != nil {
        return err
    }
    
    // è½¯åˆ é™¤
    if err := s.db.Delete(&Student{}, id).Error; err != nil {
        return fmt.Errorf("åˆ é™¤å­¦ç”Ÿå¤±è´¥: %w", err)
    }
    
    return nil
}

// Search æœç´¢å­¦ç”Ÿ
func (s *StudentService) Search(name, major, grade string, status *int) ([]Student, error) {
    var students []Student
    query := s.db.Where("deleted_at IS NULL")
    
    if name != "" {
        query = query.Where("name LIKE ?", "%"+name+"%")
    }
    if major != "" {
        query = query.Where("major LIKE ?", "%"+major+"%")
    }
    if grade != "" {
        query = query.Where("grade = ?", grade)
    }
    if status != nil {
        query = query.Where("status = ?", *status)
    }
    
    err := query.Order("created_at DESC").Find(&students).Error
    if err != nil {
        return nil, fmt.Errorf("æœç´¢å­¦ç”Ÿå¤±è´¥: %w", err)
    }
    
    return students, nil
}

// GetStatistics è·å–ç»Ÿè®¡ä¿¡æ¯
func (s *StudentService) GetStatistics() (map[string]interface{}, error) {
    var total int64
    var maleCount int64
    var femaleCount int64
    var activeCount int64
    
    baseQuery := s.db.Model(&Student{}).Where("deleted_at IS NULL")
    
    // æ€»å­¦ç”Ÿæ•°
    if err := baseQuery.Count(&total).Error; err != nil {
        return nil, fmt.Errorf("ç»Ÿè®¡æ€»æ•°å¤±è´¥: %w", err)
    }
    
    // ç”·å­¦ç”Ÿæ•°
    if err := baseQuery.Where("gender = ?", "ç”·").Count(&maleCount).Error; err != nil {
        return nil, fmt.Errorf("ç»Ÿè®¡ç”·å­¦ç”Ÿæ•°å¤±è´¥: %w", err)
    }
    
    // å¥³å­¦ç”Ÿæ•°
    if err := baseQuery.Where("gender = ?", "å¥³").Count(&femaleCount).Error; err != nil {
        return nil, fmt.Errorf("ç»Ÿè®¡å¥³å­¦ç”Ÿæ•°å¤±è´¥: %w", err)
    }
    
    // æ¿€æ´»å­¦ç”Ÿæ•°
    if err := baseQuery.Where("status = ?", 1).Count(&activeCount).Error; err != nil {
        return nil, fmt.Errorf("ç»Ÿè®¡æ¿€æ´»å­¦ç”Ÿæ•°å¤±è´¥: %w", err)
    }
    
    // ä¸“ä¸šåˆ†å¸ƒ
    var majorStats []map[string]interface{}
    err := s.db.Model(&Student{}).
        Select("major, COUNT(*) as count").
        Where("deleted_at IS NULL AND major != ''").
        Group("major").
        Order("count DESC").
        Find(&majorStats).Error
    
    if err != nil {
        return nil, fmt.Errorf("ç»Ÿè®¡ä¸“ä¸šåˆ†å¸ƒå¤±è´¥: %w", err)
    }
    
    return map[string]interface{}{
        "total":         total,
        "male_count":    maleCount,
        "female_count":  femaleCount,
        "active_count":  activeCount,
        "inactive_count": total - activeCount,
        "major_stats":   majorStats,
    }, nil
}

// BatchCreate æ‰¹é‡åˆ›å»ºå­¦ç”Ÿ
func (s *StudentService) BatchCreate(requests []CreateStudentRequest) ([]Student, error) {
    var students []Student
    
    // å¼€å¯äº‹åŠ¡
    return students, s.db.Transaction(func(tx *gorm.DB) error {
        for _, req := range requests {
            // éªŒè¯æ•°æ®
            if err := validate.Struct(&req); err != nil {
                return fmt.Errorf("ç¬¬%dä¸ªå­¦ç”Ÿæ•°æ®éªŒè¯å¤±è´¥: %w", len(students)+1, err)
            }
            
            // è½¬æ¢ä¸ºæ¨¡å‹
            student := req.ToStudent()
            
            // åˆ›å»ºå­¦ç”Ÿ
            if err := tx.Create(student).Error; err != nil {
                return fmt.Errorf("ç¬¬%dä¸ªå­¦ç”Ÿåˆ›å»ºå¤±è´¥: %w", len(students)+1, err)
            }
            
            students = append(students, *student)
        }
        
        return nil
    })
}

// ActivateStudent æ¿€æ´»å­¦ç”Ÿ
func (s *StudentService) ActivateStudent(id uint) error {
    return s.updateStatus(id, 1)
}

// DeactivateStudent ç¦ç”¨å­¦ç”Ÿ
func (s *StudentService) DeactivateStudent(id uint) error {
    return s.updateStatus(id, 0)
}

// updateStatus æ›´æ–°å­¦ç”ŸçŠ¶æ€
func (s *StudentService) updateStatus(id uint, status int) error {
    result := s.db.Model(&Student{}).Where("id = ?", id).Update("status", status)
    if result.Error != nil {
        return fmt.Errorf("æ›´æ–°å­¦ç”ŸçŠ¶æ€å¤±è´¥: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return errors.New("å­¦ç”Ÿä¸å­˜åœ¨")
    }
    return nil
}
```

## 4.5 æ¨¡å‹æµ‹è¯•

### å•å…ƒæµ‹è¯•

```go
package models

import (
    "testing"
    
    "github.com/stretchr/testify/assert"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

func setupTestDB() *gorm.DB {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    if err != nil {
        panic("failed to connect test database")
    }
    
    // è¿ç§»æµ‹è¯•è¡¨
    db.AutoMigrate(&Student{})
    
    return db
}

func TestStudentValidation(t *testing.T) {
    tests := []struct {
        name    string
        student Student
        wantErr bool
    }{
        {
            name: "æœ‰æ•ˆå­¦ç”Ÿæ•°æ®",
            student: Student{
                Name:   "å¼ ä¸‰",
                Age:    20,
                Gender: "ç”·",
                Email:  "zhangsan@example.com",
                Phone:  "13800138000",
            },
            wantErr: false,
        },
        {
            name: "æ— æ•ˆé‚®ç®±",
            student: Student{
                Name:   "æå››",
                Age:    21,
                Gender: "å¥³",
                Email:  "invalid-email",
            },
            wantErr: true,
        },
        {
            name: "å¹´é¾„è¶…å‡ºèŒƒå›´",
            student: Student{
                Name:   "ç‹äº”",
                Age:    200,
                Gender: "ç”·",
                Email:  "wangwu@example.com",
            },
            wantErr: true,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := tt.student.Validate()
            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
            }
        })
    }
}

func TestStudentService(t *testing.T) {
    db := setupTestDB()
    service := NewStudentService(db)
    
    // æµ‹è¯•åˆ›å»ºå­¦ç”Ÿ
    req := &CreateStudentRequest{
        Name:   "æµ‹è¯•å­¦ç”Ÿ",
        Age:    20,
        Gender: "ç”·",
        Email:  "test@example.com",
        Major:  "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯",
        Grade:  "2023çº§",
    }
    
    student, err := service.Create(req)
    assert.NoError(t, err)
    assert.NotZero(t, student.ID)
    assert.Equal(t, "æµ‹è¯•å­¦ç”Ÿ", student.Name)
    assert.NotEmpty(t, student.StudentID)
    
    // æµ‹è¯•æŸ¥è¯¢å­¦ç”Ÿ
    found, err := service.GetByID(student.ID)
    assert.NoError(t, err)
    assert.Equal(t, student.ID, found.ID)
    
    // æµ‹è¯•æ›´æ–°å­¦ç”Ÿ
    updateReq := &UpdateStudentRequest{
        Age: &[]int{21}[0],
    }
    
    updated, err := service.Update(student.ID, updateReq)
    assert.NoError(t, err)
    assert.Equal(t, 21, updated.Age)
    
    // æµ‹è¯•åˆ é™¤å­¦ç”Ÿ
    err = service.Delete(student.ID)
    assert.NoError(t, err)
    
    // éªŒè¯è½¯åˆ é™¤
    _, err = service.GetByID(student.ID)
    assert.Error(t, err)
}
```

## 4.6 æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ç´¢å¼•

```go
// åœ¨æ¨¡å‹ä¸­å®šä¹‰ç´¢å¼•
type Student struct {
    // ...
    Email string `gorm:"uniqueIndex:idx_email"`
    Name  string `gorm:"index:idx_name"`
    Major string `gorm:"index:idx_major"`
    Grade string `gorm:"index:idx_grade"`
    
    // å¤åˆç´¢å¼•
    Major string `gorm:"index:idx_major_grade"`
    Grade string `gorm:"index:idx_major_grade"`
}
```

### æŸ¥è¯¢ä¼˜åŒ–

```go
// ä½¿ç”¨SelectæŒ‡å®šå­—æ®µ
func (s *StudentService) GetStudentList() ([]Student, error) {
    var students []Student
    err := s.db.Select("id, name, email, major, grade, status").
        Where("deleted_at IS NULL").
        Find(&students).Error
    return students, err
}

// ä½¿ç”¨åŸç”ŸSQLä¼˜åŒ–å¤æ‚æŸ¥è¯¢
func (s *StudentService) GetMajorStatistics() ([]map[string]interface{}, error) {
    var results []map[string]interface{}
    err := s.db.Raw(`
        SELECT 
            major,
            COUNT(*) as total,
            SUM(CASE WHEN gender = 'ç”·' THEN 1 ELSE 0 END) as male_count,
            SUM(CASE WHEN gender = 'å¥³' THEN 1 ELSE 0 END) as female_count
        FROM students 
        WHERE deleted_at IS NULL AND major != ''
        GROUP BY major
        ORDER BY total DESC
    `).Scan(&results).Error
    
    return results, err
}
```

## 4.7 ä¸‹ä¸€æ­¥

æ¨¡å‹å±‚å¼€å‘å®Œæˆåï¼Œä½ åº”è¯¥æŒæ¡ï¼š
- âœ… å®Œæ•´çš„å­¦ç”Ÿæ¨¡å‹å®šä¹‰å’ŒéªŒè¯
- âœ… è‡ªå®šä¹‰éªŒè¯å™¨çš„å®ç°
- âœ… GORMé’©å­å‡½æ•°çš„ä½¿ç”¨
- âœ… DTOæ¨¡å¼çš„åº”ç”¨
- âœ… ä¸šåŠ¡é€»è¾‘å±‚çš„å°è£…
- âœ… å•å…ƒæµ‹è¯•çš„ç¼–å†™

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨[ç¬¬5ç« ï¼šæ§åˆ¶å™¨å±‚å¼€å‘](./05-æ§åˆ¶å™¨å±‚å¼€å‘.md)ä¸­å­¦ä¹ å¦‚ä½•å®ç°HTTPè¯·æ±‚å¤„ç†å’ŒAPIæ¥å£ã€‚

## å‚è€ƒèµ„æº

- [Go Validatoræ–‡æ¡£](https://github.com/go-playground/validator)
- [GORMé’©å­å‡½æ•°](https://gorm.io/docs/hooks.html)
- [Goæµ‹è¯•æœ€ä½³å®è·µ](https://go.dev/doc/tutorial/add-a-test)
- [æ•°æ®ä¼ è¾“å¯¹è±¡æ¨¡å¼](https://martinfowler.com/eaaCatalog/dataTransferObject.html)