# ç¬¬5ç« ï¼šæ§åˆ¶å™¨å±‚å¼€å‘

æœ¬ç« å°†è¯¦ç»†ä»‹ç»æ§åˆ¶å™¨å±‚çš„å¼€å‘ï¼ŒåŒ…æ‹¬HTTPè¯·æ±‚å¤„ç†ã€APIæ¥å£è®¾è®¡ã€é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼åŒ–ã€‚

## 5.1 æ§åˆ¶å™¨å±‚èŒè´£

æ§åˆ¶å™¨å±‚ï¼ˆControllerï¼‰åœ¨MVCæ¶æ„ä¸­æ‰¿æ‹…ä»¥ä¸‹èŒè´£ï¼š

- ğŸŒ **HTTPè¯·æ±‚å¤„ç†**ï¼šæ¥æ”¶å’Œè§£æHTTPè¯·æ±‚
- ğŸ”„ **æ•°æ®è½¬æ¢**ï¼šè¯·æ±‚æ•°æ®ä¸æ¨¡å‹æ•°æ®çš„è½¬æ¢
- ğŸ“ **ä¸šåŠ¡é€»è¾‘è°ƒç”¨**ï¼šè°ƒç”¨æ¨¡å‹å±‚çš„ä¸šåŠ¡æ–¹æ³•
- ğŸ“¤ **å“åº”æ ¼å¼åŒ–**ï¼šç»Ÿä¸€APIå“åº”æ ¼å¼
- âŒ **é”™è¯¯å¤„ç†**ï¼šå¤„ç†å’Œè¿”å›é”™è¯¯ä¿¡æ¯
- âœ… **æ•°æ®éªŒè¯**ï¼šéªŒè¯è¯·æ±‚å‚æ•°çš„æœ‰æ•ˆæ€§

## 5.2 æ§åˆ¶å™¨åŸºç¡€ç»“æ„

### æ§åˆ¶å™¨å®šä¹‰

**æ–‡ä»¶è·¯å¾„ï¼š** `controllers/student_controller.go`

```go
package controllers

import (
    "net/http"
    "strconv"
    "strings"
    
    "github.com/gin-gonic/gin"
    "your-project/models"
    "your-project/utils"
)

// StudentController å­¦ç”Ÿæ§åˆ¶å™¨
type StudentController struct {
    studentService *models.StudentService
}

// NewStudentController åˆ›å»ºå­¦ç”Ÿæ§åˆ¶å™¨å®ä¾‹
func NewStudentController(studentService *models.StudentService) *StudentController {
    return &StudentController{
        studentService: studentService,
    }
}
```

### å“åº”å·¥å…·å‡½æ•°

**æ–‡ä»¶è·¯å¾„ï¼š** `utils/response.go`

```go
package utils

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
)

// Response ç»Ÿä¸€å“åº”ç»“æ„
type Response struct {
    Success bool        `json:"success"`
    Message string      `json:"message"`
    Data    interface{} `json:"data,omitempty"`
    Error   string      `json:"error,omitempty"`
    Code    string      `json:"code,omitempty"`
}

// SuccessResponse æˆåŠŸå“åº”
func SuccessResponse(c *gin.Context, message string, data interface{}) {
    c.JSON(http.StatusOK, Response{
        Success: true,
        Message: message,
        Data:    data,
    })
}

// CreatedResponse åˆ›å»ºæˆåŠŸå“åº”
func CreatedResponse(c *gin.Context, message string, data interface{}) {
    c.JSON(http.StatusCreated, Response{
        Success: true,
        Message: message,
        Data:    data,
    })
}

// ErrorResponse é”™è¯¯å“åº”
func ErrorResponse(c *gin.Context, statusCode int, message string, err error) {
    response := Response{
        Success: false,
        Message: message,
    }
    
    if err != nil {
        response.Error = err.Error()
    }
    
    c.JSON(statusCode, response)
}

// BadRequestResponse 400é”™è¯¯å“åº”
func BadRequestResponse(c *gin.Context, message string, err error) {
    ErrorResponse(c, http.StatusBadRequest, message, err)
}

// NotFoundResponse 404é”™è¯¯å“åº”
func NotFoundResponse(c *gin.Context, message string) {
    ErrorResponse(c, http.StatusNotFound, message, nil)
}

// InternalServerErrorResponse 500é”™è¯¯å“åº”
func InternalServerErrorResponse(c *gin.Context, message string, err error) {
    ErrorResponse(c, http.StatusInternalServerError, message, err)
}

// ValidationErrorResponse éªŒè¯é”™è¯¯å“åº”
func ValidationErrorResponse(c *gin.Context, err error) {
    ErrorResponse(c, http.StatusBadRequest, "æ•°æ®éªŒè¯å¤±è´¥", err)
}
```

## 5.3 CRUDæ“ä½œå®ç°

### åˆ›å»ºå­¦ç”Ÿ

```go
// CreateStudent åˆ›å»ºå­¦ç”Ÿ
// @Summary åˆ›å»ºå­¦ç”Ÿ
// @Description åˆ›å»ºæ–°çš„å­¦ç”Ÿè®°å½•
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param student body models.CreateStudentRequest true "å­¦ç”Ÿä¿¡æ¯"
// @Success 201 {object} utils.Response{data=models.StudentResponse}
// @Failure 400 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students [post]
func (sc *StudentController) CreateStudent(c *gin.Context) {
    var req models.CreateStudentRequest
    
    // ç»‘å®šJSONæ•°æ®
    if err := c.ShouldBindJSON(&req); err != nil {
        utils.BadRequestResponse(c, "è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯", err)
        return
    }
    
    // åˆ›å»ºå­¦ç”Ÿ
    student, err := sc.studentService.Create(&req)
    if err != nil {
        if strings.Contains(err.Error(), "æ•°æ®éªŒè¯å¤±è´¥") {
            utils.ValidationErrorResponse(c, err)
            return
        }
        if strings.Contains(err.Error(), "é‚®ç®±å·²å­˜åœ¨") {
            utils.BadRequestResponse(c, "é‚®ç®±å·²å­˜åœ¨", err)
            return
        }
        utils.InternalServerErrorResponse(c, "åˆ›å»ºå­¦ç”Ÿå¤±è´¥", err)
        return
    }
    
    // è½¬æ¢ä¸ºå“åº”æ ¼å¼
    var response models.StudentResponse
    response.FromStudent(student)
    
    utils.CreatedResponse(c, "å­¦ç”Ÿåˆ›å»ºæˆåŠŸ", response)
}
```

### è·å–å­¦ç”Ÿåˆ—è¡¨

```go
// GetAllStudents è·å–æ‰€æœ‰å­¦ç”Ÿ
// @Summary è·å–å­¦ç”Ÿåˆ—è¡¨
// @Description è·å–æ‰€æœ‰å­¦ç”Ÿçš„åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µ
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param page query int false "é¡µç " default(1)
// @Param page_size query int false "æ¯é¡µæ•°é‡" default(10)
// @Success 200 {object} utils.Response{data=models.StudentListResponse}
// @Failure 500 {object} utils.Response
// @Router /api/v1/students [get]
func (sc *StudentController) GetAllStudents(c *gin.Context) {
    // è·å–åˆ†é¡µå‚æ•°
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(c.DefaultQuery("page_size", "10"))
    
    // å‚æ•°éªŒè¯
    if page < 1 {
        page = 1
    }
    if pageSize < 1 || pageSize > 100 {
        pageSize = 10
    }
    
    var students []models.Student
    var total int64
    var err error
    
    // æ ¹æ®æ˜¯å¦åˆ†é¡µé€‰æ‹©ä¸åŒçš„æŸ¥è¯¢æ–¹æ³•
    if c.Query("page") != "" || c.Query("page_size") != "" {
        students, total, err = sc.studentService.GetWithPagination(page, pageSize)
    } else {
        students, err = sc.studentService.GetAll()
        total = int64(len(students))
        page = 1
        pageSize = len(students)
    }
    
    if err != nil {
        utils.InternalServerErrorResponse(c, "è·å–å­¦ç”Ÿåˆ—è¡¨å¤±è´¥", err)
        return
    }
    
    // è½¬æ¢ä¸ºå“åº”æ ¼å¼
    var studentResponses []models.StudentResponse
    for _, student := range students {
        var response models.StudentResponse
        response.FromStudent(&student)
        studentResponses = append(studentResponses, response)
    }
    
    // æ„å»ºåˆ—è¡¨å“åº”
    listResponse := models.StudentListResponse{
        Students: studentResponses,
        Total:    total,
        Page:     page,
        PageSize: pageSize,
    }
    
    utils.SuccessResponse(c, "è·å–å­¦ç”Ÿåˆ—è¡¨æˆåŠŸ", listResponse)
}
```

### è·å–å•ä¸ªå­¦ç”Ÿ

```go
// GetStudentByID æ ¹æ®IDè·å–å­¦ç”Ÿ
// @Summary è·å–å­¦ç”Ÿè¯¦æƒ…
// @Description æ ¹æ®å­¦ç”ŸIDè·å–å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param id path int true "å­¦ç”ŸID"
// @Success 200 {object} utils.Response{data=models.StudentResponse}
// @Failure 400 {object} utils.Response
// @Failure 404 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/{id} [get]
func (sc *StudentController) GetStudentByID(c *gin.Context) {
    // è·å–è·¯å¾„å‚æ•°
    idStr := c.Param("id")
    id, err := strconv.ParseUint(idStr, 10, 32)
    if err != nil {
        utils.BadRequestResponse(c, "æ— æ•ˆçš„å­¦ç”ŸID", err)
        return
    }
    
    // æŸ¥è¯¢å­¦ç”Ÿ
    student, err := sc.studentService.GetByID(uint(id))
    if err != nil {
        if strings.Contains(err.Error(), "å­¦ç”Ÿä¸å­˜åœ¨") {
            utils.NotFoundResponse(c, "å­¦ç”Ÿä¸å­˜åœ¨")
            return
        }
        utils.InternalServerErrorResponse(c, "è·å–å­¦ç”Ÿä¿¡æ¯å¤±è´¥", err)
        return
    }
    
    // è½¬æ¢ä¸ºå“åº”æ ¼å¼
    var response models.StudentResponse
    response.FromStudent(student)
    
    utils.SuccessResponse(c, "è·å–å­¦ç”Ÿä¿¡æ¯æˆåŠŸ", response)
}
```

### æ›´æ–°å­¦ç”Ÿ

```go
// UpdateStudent æ›´æ–°å­¦ç”Ÿä¿¡æ¯
// @Summary æ›´æ–°å­¦ç”Ÿ
// @Description æ›´æ–°æŒ‡å®šå­¦ç”Ÿçš„ä¿¡æ¯
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param id path int true "å­¦ç”ŸID"
// @Param student body models.UpdateStudentRequest true "æ›´æ–°çš„å­¦ç”Ÿä¿¡æ¯"
// @Success 200 {object} utils.Response{data=models.StudentResponse}
// @Failure 400 {object} utils.Response
// @Failure 404 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/{id} [put]
func (sc *StudentController) UpdateStudent(c *gin.Context) {
    // è·å–è·¯å¾„å‚æ•°
    idStr := c.Param("id")
    id, err := strconv.ParseUint(idStr, 10, 32)
    if err != nil {
        utils.BadRequestResponse(c, "æ— æ•ˆçš„å­¦ç”ŸID", err)
        return
    }
    
    // ç»‘å®šè¯·æ±‚æ•°æ®
    var req models.UpdateStudentRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        utils.BadRequestResponse(c, "è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯", err)
        return
    }
    
    // æ›´æ–°å­¦ç”Ÿ
    student, err := sc.studentService.Update(uint(id), &req)
    if err != nil {
        if strings.Contains(err.Error(), "å­¦ç”Ÿä¸å­˜åœ¨") {
            utils.NotFoundResponse(c, "å­¦ç”Ÿä¸å­˜åœ¨")
            return
        }
        if strings.Contains(err.Error(), "æ•°æ®éªŒè¯å¤±è´¥") {
            utils.ValidationErrorResponse(c, err)
            return
        }
        if strings.Contains(err.Error(), "é‚®ç®±å·²å­˜åœ¨") {
            utils.BadRequestResponse(c, "é‚®ç®±å·²å­˜åœ¨", err)
            return
        }
        utils.InternalServerErrorResponse(c, "æ›´æ–°å­¦ç”Ÿä¿¡æ¯å¤±è´¥", err)
        return
    }
    
    // è½¬æ¢ä¸ºå“åº”æ ¼å¼
    var response models.StudentResponse
    response.FromStudent(student)
    
    utils.SuccessResponse(c, "å­¦ç”Ÿä¿¡æ¯æ›´æ–°æˆåŠŸ", response)
}
```

### åˆ é™¤å­¦ç”Ÿ

```go
// DeleteStudent åˆ é™¤å­¦ç”Ÿ
// @Summary åˆ é™¤å­¦ç”Ÿ
// @Description è½¯åˆ é™¤æŒ‡å®šçš„å­¦ç”Ÿè®°å½•
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param id path int true "å­¦ç”ŸID"
// @Success 200 {object} utils.Response
// @Failure 400 {object} utils.Response
// @Failure 404 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/{id} [delete]
func (sc *StudentController) DeleteStudent(c *gin.Context) {
    // è·å–è·¯å¾„å‚æ•°
    idStr := c.Param("id")
    id, err := strconv.ParseUint(idStr, 10, 32)
    if err != nil {
        utils.BadRequestResponse(c, "æ— æ•ˆçš„å­¦ç”ŸID", err)
        return
    }
    
    // åˆ é™¤å­¦ç”Ÿ
    err = sc.studentService.Delete(uint(id))
    if err != nil {
        if strings.Contains(err.Error(), "å­¦ç”Ÿä¸å­˜åœ¨") {
            utils.NotFoundResponse(c, "å­¦ç”Ÿä¸å­˜åœ¨")
            return
        }
        utils.InternalServerErrorResponse(c, "åˆ é™¤å­¦ç”Ÿå¤±è´¥", err)
        return
    }
    
    utils.SuccessResponse(c, "å­¦ç”Ÿåˆ é™¤æˆåŠŸ", nil)
}
```

## 5.4 é«˜çº§åŠŸèƒ½å®ç°

### æœç´¢åŠŸèƒ½

```go
// SearchStudents æœç´¢å­¦ç”Ÿ
// @Summary æœç´¢å­¦ç”Ÿ
// @Description æ ¹æ®æ¡ä»¶æœç´¢å­¦ç”Ÿ
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param name query string false "å­¦ç”Ÿå§“åï¼ˆæ¨¡ç³Šæœç´¢ï¼‰"
// @Param major query string false "ä¸“ä¸šï¼ˆæ¨¡ç³Šæœç´¢ï¼‰"
// @Param grade query string false "å¹´çº§ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰"
// @Param status query int false "çŠ¶æ€ï¼ˆ0:ç¦ç”¨,1:æ­£å¸¸ï¼‰"
// @Success 200 {object} utils.Response{data=[]models.StudentResponse}
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/search [get]
func (sc *StudentController) SearchStudents(c *gin.Context) {
    // è·å–æŸ¥è¯¢å‚æ•°
    name := strings.TrimSpace(c.Query("name"))
    major := strings.TrimSpace(c.Query("major"))
    grade := strings.TrimSpace(c.Query("grade"))
    statusStr := c.Query("status")
    
    var status *int
    if statusStr != "" {
        if s, err := strconv.Atoi(statusStr); err == nil && (s == 0 || s == 1) {
            status = &s
        }
    }
    
    // æœç´¢å­¦ç”Ÿ
    students, err := sc.studentService.Search(name, major, grade, status)
    if err != nil {
        utils.InternalServerErrorResponse(c, "æœç´¢å­¦ç”Ÿå¤±è´¥", err)
        return
    }
    
    // è½¬æ¢ä¸ºå“åº”æ ¼å¼
    var studentResponses []models.StudentResponse
    for _, student := range students {
        var response models.StudentResponse
        response.FromStudent(&student)
        studentResponses = append(studentResponses, response)
    }
    
    utils.SuccessResponse(c, "æœç´¢å®Œæˆ", studentResponses)
}
```

### ç»Ÿè®¡ä¿¡æ¯

```go
// GetStatistics è·å–ç»Ÿè®¡ä¿¡æ¯
// @Summary è·å–ç»Ÿè®¡ä¿¡æ¯
// @Description è·å–å­¦ç”Ÿç›¸å…³çš„ç»Ÿè®¡æ•°æ®
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Success 200 {object} utils.Response{data=map[string]interface{}}
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/statistics [get]
func (sc *StudentController) GetStatistics(c *gin.Context) {
    stats, err := sc.studentService.GetStatistics()
    if err != nil {
        utils.InternalServerErrorResponse(c, "è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", err)
        return
    }
    
    utils.SuccessResponse(c, "è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ", stats)
}
```

### æ‰¹é‡æ“ä½œ

```go
// BatchCreateStudents æ‰¹é‡åˆ›å»ºå­¦ç”Ÿ
// @Summary æ‰¹é‡åˆ›å»ºå­¦ç”Ÿ
// @Description æ‰¹é‡åˆ›å»ºå¤šä¸ªå­¦ç”Ÿè®°å½•
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param students body []models.CreateStudentRequest true "å­¦ç”Ÿä¿¡æ¯åˆ—è¡¨"
// @Success 201 {object} utils.Response{data=[]models.StudentResponse}
// @Failure 400 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/batch [post]
func (sc *StudentController) BatchCreateStudents(c *gin.Context) {
    var requests []models.CreateStudentRequest
    
    // ç»‘å®šJSONæ•°æ®
    if err := c.ShouldBindJSON(&requests); err != nil {
        utils.BadRequestResponse(c, "è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯", err)
        return
    }
    
    // éªŒè¯æ‰¹é‡æ•°é‡
    if len(requests) == 0 {
        utils.BadRequestResponse(c, "å­¦ç”Ÿåˆ—è¡¨ä¸èƒ½ä¸ºç©º", nil)
        return
    }
    if len(requests) > 100 {
        utils.BadRequestResponse(c, "æ‰¹é‡åˆ›å»ºæ•°é‡ä¸èƒ½è¶…è¿‡100ä¸ª", nil)
        return
    }
    
    // æ‰¹é‡åˆ›å»ºå­¦ç”Ÿ
    students, err := sc.studentService.BatchCreate(requests)
    if err != nil {
        utils.InternalServerErrorResponse(c, "æ‰¹é‡åˆ›å»ºå­¦ç”Ÿå¤±è´¥", err)
        return
    }
    
    // è½¬æ¢ä¸ºå“åº”æ ¼å¼
    var studentResponses []models.StudentResponse
    for _, student := range students {
        var response models.StudentResponse
        response.FromStudent(&student)
        studentResponses = append(studentResponses, response)
    }
    
    utils.CreatedResponse(c, fmt.Sprintf("æˆåŠŸåˆ›å»º%dä¸ªå­¦ç”Ÿ", len(students)), studentResponses)
}

// BatchDeleteStudents æ‰¹é‡åˆ é™¤å­¦ç”Ÿ
// @Summary æ‰¹é‡åˆ é™¤å­¦ç”Ÿ
// @Description æ‰¹é‡åˆ é™¤å¤šä¸ªå­¦ç”Ÿè®°å½•
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param ids body []uint true "å­¦ç”ŸIDåˆ—è¡¨"
// @Success 200 {object} utils.Response
// @Failure 400 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/batch [delete]
func (sc *StudentController) BatchDeleteStudents(c *gin.Context) {
    var ids []uint
    
    // ç»‘å®šJSONæ•°æ®
    if err := c.ShouldBindJSON(&ids); err != nil {
        utils.BadRequestResponse(c, "è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯", err)
        return
    }
    
    // éªŒè¯IDåˆ—è¡¨
    if len(ids) == 0 {
        utils.BadRequestResponse(c, "IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º", nil)
        return
    }
    if len(ids) > 100 {
        utils.BadRequestResponse(c, "æ‰¹é‡åˆ é™¤æ•°é‡ä¸èƒ½è¶…è¿‡100ä¸ª", nil)
        return
    }
    
    // æ‰¹é‡åˆ é™¤
    var successCount int
    var errors []string
    
    for _, id := range ids {
        if err := sc.studentService.Delete(id); err != nil {
            errors = append(errors, fmt.Sprintf("ID %d: %s", id, err.Error()))
        } else {
            successCount++
        }
    }
    
    // æ„å»ºå“åº”
    result := map[string]interface{}{
        "success_count": successCount,
        "total_count":   len(ids),
        "errors":        errors,
    }
    
    if len(errors) > 0 {
        utils.SuccessResponse(c, fmt.Sprintf("æ‰¹é‡åˆ é™¤å®Œæˆï¼ŒæˆåŠŸ%dä¸ªï¼Œå¤±è´¥%dä¸ª", successCount, len(errors)), result)
    } else {
        utils.SuccessResponse(c, fmt.Sprintf("æˆåŠŸåˆ é™¤%dä¸ªå­¦ç”Ÿ", successCount), result)
    }
}
```

### çŠ¶æ€ç®¡ç†

```go
// ActivateStudent æ¿€æ´»å­¦ç”Ÿ
// @Summary æ¿€æ´»å­¦ç”Ÿ
// @Description æ¿€æ´»æŒ‡å®šçš„å­¦ç”Ÿè´¦æˆ·
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param id path int true "å­¦ç”ŸID"
// @Success 200 {object} utils.Response
// @Failure 400 {object} utils.Response
// @Failure 404 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/{id}/activate [put]
func (sc *StudentController) ActivateStudent(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseUint(idStr, 10, 32)
    if err != nil {
        utils.BadRequestResponse(c, "æ— æ•ˆçš„å­¦ç”ŸID", err)
        return
    }
    
    err = sc.studentService.ActivateStudent(uint(id))
    if err != nil {
        if strings.Contains(err.Error(), "å­¦ç”Ÿä¸å­˜åœ¨") {
            utils.NotFoundResponse(c, "å­¦ç”Ÿä¸å­˜åœ¨")
            return
        }
        utils.InternalServerErrorResponse(c, "æ¿€æ´»å­¦ç”Ÿå¤±è´¥", err)
        return
    }
    
    utils.SuccessResponse(c, "å­¦ç”Ÿæ¿€æ´»æˆåŠŸ", nil)
}

// DeactivateStudent ç¦ç”¨å­¦ç”Ÿ
// @Summary ç¦ç”¨å­¦ç”Ÿ
// @Description ç¦ç”¨æŒ‡å®šçš„å­¦ç”Ÿè´¦æˆ·
// @Tags å­¦ç”Ÿç®¡ç†
// @Accept json
// @Produce json
// @Param id path int true "å­¦ç”ŸID"
// @Success 200 {object} utils.Response
// @Failure 400 {object} utils.Response
// @Failure 404 {object} utils.Response
// @Failure 500 {object} utils.Response
// @Router /api/v1/students/{id}/deactivate [put]
func (sc *StudentController) DeactivateStudent(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseUint(idStr, 10, 32)
    if err != nil {
        utils.BadRequestResponse(c, "æ— æ•ˆçš„å­¦ç”ŸID", err)
        return
    }
    
    err = sc.studentService.DeactivateStudent(uint(id))
    if err != nil {
        if strings.Contains(err.Error(), "å­¦ç”Ÿä¸å­˜åœ¨") {
            utils.NotFoundResponse(c, "å­¦ç”Ÿä¸å­˜åœ¨")
            return
        }
        utils.InternalServerErrorResponse(c, "ç¦ç”¨å­¦ç”Ÿå¤±è´¥", err)
        return
    }
    
    utils.SuccessResponse(c, "å­¦ç”Ÿç¦ç”¨æˆåŠŸ", nil)
}
```

## 5.5 ä¸­é—´ä»¶é›†æˆ

### æ—¥å¿—ä¸­é—´ä»¶

**æ–‡ä»¶è·¯å¾„ï¼š** `middleware/logger.go`

```go
package middleware

import (
    "log"
    "time"
    
    "github.com/gin-gonic/gin"
)

// Logger æ—¥å¿—ä¸­é—´ä»¶
func Logger() gin.HandlerFunc {
    return gin.LoggerWithFormatter(func(param gin.LogFormatterParams) string {
        return fmt.Sprintf("%s - [%s] \"%s %s %s %d %s \"%s\" %s\"\
",
            param.ClientIP,
            param.TimeStamp.Format(time.RFC1123),
            param.Method,
            param.Path,
            param.Request.Proto,
            param.StatusCode,
            param.Latency,
            param.Request.UserAgent(),
            param.ErrorMessage,
        )
    })
}

// CustomLogger è‡ªå®šä¹‰æ—¥å¿—ä¸­é—´ä»¶
func CustomLogger() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        path := c.Request.URL.Path
        raw := c.Request.URL.RawQuery
        
        // å¤„ç†è¯·æ±‚
        c.Next()
        
        // è®°å½•æ—¥å¿—
        latency := time.Since(start)
        clientIP := c.ClientIP()
        method := c.Request.Method
        statusCode := c.Writer.Status()
        
        if raw != "" {
            path = path + "?" + raw
        }
        
        log.Printf("[%s] %s %s %d %v",
            method,
            path,
            clientIP,
            statusCode,
            latency,
        )
    }
}
```

### é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**æ–‡ä»¶è·¯å¾„ï¼š** `middleware/error_handler.go`

```go
package middleware

import (
    "log"
    "net/http"
    
    "github.com/gin-gonic/gin"
    "your-project/utils"
)

// ErrorHandler å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
func ErrorHandler() gin.HandlerFunc {
    return func(c *gin.Context) {
        defer func() {
            if err := recover(); err != nil {
                log.Printf("Panic recovered: %v", err)
                utils.InternalServerErrorResponse(c, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", fmt.Errorf("%v", err))
                c.Abort()
            }
        }()
        
        c.Next()
        
        // å¤„ç†é”™è¯¯
        if len(c.Errors) > 0 {
            err := c.Errors.Last()
            log.Printf("Request error: %v", err)
            
            switch err.Type {
            case gin.ErrorTypeBind:
                utils.BadRequestResponse(c, "è¯·æ±‚å‚æ•°é”™è¯¯", err.Err)
            case gin.ErrorTypePublic:
                utils.ErrorResponse(c, http.StatusInternalServerError, "æœåŠ¡å™¨é”™è¯¯", err.Err)
            default:
                utils.InternalServerErrorResponse(c, "æœªçŸ¥é”™è¯¯", err.Err)
            }
        }
    }
}
```

### éªŒè¯ä¸­é—´ä»¶

```go
// ValidateJSON éªŒè¯JSONä¸­é—´ä»¶
func ValidateJSON() gin.HandlerFunc {
    return func(c *gin.Context) {
        if c.Request.Method == "POST" || c.Request.Method == "PUT" {
            contentType := c.GetHeader("Content-Type")
            if !strings.Contains(contentType, "application/json") {
                utils.BadRequestResponse(c, "Content-Typeå¿…é¡»æ˜¯application/json", nil)
                c.Abort()
                return
            }
        }
        c.Next()
    }
}

// ValidateStudentID éªŒè¯å­¦ç”ŸIDä¸­é—´ä»¶
func ValidateStudentID() gin.HandlerFunc {
    return func(c *gin.Context) {
        idStr := c.Param("id")
        if idStr != "" {
            id, err := strconv.ParseUint(idStr, 10, 32)
            if err != nil || id == 0 {
                utils.BadRequestResponse(c, "æ— æ•ˆçš„å­¦ç”ŸID", err)
                c.Abort()
                return
            }
            // å°†è§£æåçš„IDå­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­
            c.Set("student_id", uint(id))
        }
        c.Next()
    }
}
```

## 5.6 æ§åˆ¶å™¨æµ‹è¯•

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶è·¯å¾„ï¼š** `controllers/student_controller_test.go`

```go
package controllers

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"
    
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "your-project/models"
)

// MockStudentService æ¨¡æ‹Ÿå­¦ç”ŸæœåŠ¡
type MockStudentService struct {
    mock.Mock
}

func (m *MockStudentService) Create(req *models.CreateStudentRequest) (*models.Student, error) {
    args := m.Called(req)
    return args.Get(0).(*models.Student), args.Error(1)
}

func (m *MockStudentService) GetByID(id uint) (*models.Student, error) {
    args := m.Called(id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*models.Student), args.Error(1)
}

func (m *MockStudentService) GetAll() ([]models.Student, error) {
    args := m.Called()
    return args.Get(0).([]models.Student), args.Error(1)
}

func (m *MockStudentService) Update(id uint, req *models.UpdateStudentRequest) (*models.Student, error) {
    args := m.Called(id, req)
    return args.Get(0).(*models.Student), args.Error(1)
}

func (m *MockStudentService) Delete(id uint) error {
    args := m.Called(id)
    return args.Error(0)
}

func setupTestRouter() (*gin.Engine, *MockStudentService) {
    gin.SetMode(gin.TestMode)
    
    mockService := new(MockStudentService)
    controller := NewStudentController(mockService)
    
    router := gin.New()
    v1 := router.Group("/api/v1")
    {
        v1.POST("/students", controller.CreateStudent)
        v1.GET("/students/:id", controller.GetStudentByID)
        v1.GET("/students", controller.GetAllStudents)
        v1.PUT("/students/:id", controller.UpdateStudent)
        v1.DELETE("/students/:id", controller.DeleteStudent)
    }
    
    return router, mockService
}

func TestCreateStudent(t *testing.T) {
    router, mockService := setupTestRouter()
    
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    student := &models.Student{
        ID:     1,
        Name:   "å¼ ä¸‰",
        Age:    20,
        Gender: "ç”·",
        Email:  "zhangsan@example.com",
    }
    
    mockService.On("Create", mock.AnythingOfType("*models.CreateStudentRequest")).Return(student, nil)
    
    // å‡†å¤‡è¯·æ±‚æ•°æ®
    requestBody := models.CreateStudentRequest{
        Name:   "å¼ ä¸‰",
        Age:    20,
        Gender: "ç”·",
        Email:  "zhangsan@example.com",
    }
    
    jsonData, _ := json.Marshal(requestBody)
    
    // å‘é€è¯·æ±‚
    req, _ := http.NewRequest("POST", "/api/v1/students", bytes.NewBuffer(jsonData))
    req.Header.Set("Content-Type", "application/json")
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // éªŒè¯å“åº”
    assert.Equal(t, http.StatusCreated, w.Code)
    
    var response map[string]interface{}
    err := json.Unmarshal(w.Body.Bytes(), &response)
    assert.NoError(t, err)
    assert.True(t, response["success"].(bool))
    assert.Equal(t, "å­¦ç”Ÿåˆ›å»ºæˆåŠŸ", response["message"])
    
    mockService.AssertExpectations(t)
}

func TestGetStudentByID(t *testing.T) {
    router, mockService := setupTestRouter()
    
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    student := &models.Student{
        ID:     1,
        Name:   "å¼ ä¸‰",
        Age:    20,
        Gender: "ç”·",
        Email:  "zhangsan@example.com",
    }
    
    mockService.On("GetByID", uint(1)).Return(student, nil)
    
    // å‘é€è¯·æ±‚
    req, _ := http.NewRequest("GET", "/api/v1/students/1", nil)
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // éªŒè¯å“åº”
    assert.Equal(t, http.StatusOK, w.Code)
    
    var response map[string]interface{}
    err := json.Unmarshal(w.Body.Bytes(), &response)
    assert.NoError(t, err)
    assert.True(t, response["success"].(bool))
    
    data := response["data"].(map[string]interface{})
    assert.Equal(t, "å¼ ä¸‰", data["name"])
    
    mockService.AssertExpectations(t)
}

func TestGetStudentByID_NotFound(t *testing.T) {
    router, mockService := setupTestRouter()
    
    mockService.On("GetByID", uint(999)).Return(nil, errors.New("å­¦ç”Ÿä¸å­˜åœ¨"))
    
    // å‘é€è¯·æ±‚
    req, _ := http.NewRequest("GET", "/api/v1/students/999", nil)
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // éªŒè¯å“åº”
    assert.Equal(t, http.StatusNotFound, w.Code)
    
    var response map[string]interface{}
    err := json.Unmarshal(w.Body.Bytes(), &response)
    assert.NoError(t, err)
    assert.False(t, response["success"].(bool))
    assert.Equal(t, "å­¦ç”Ÿä¸å­˜åœ¨", response["message"])
    
    mockService.AssertExpectations(t)
}
```

### é›†æˆæµ‹è¯•

```go
func TestStudentControllerIntegration(t *testing.T) {
    // è®¾ç½®æµ‹è¯•æ•°æ®åº“
    db := setupTestDB()
    service := models.NewStudentService(db)
    controller := NewStudentController(service)
    
    // è®¾ç½®è·¯ç”±
    router := gin.New()
    v1 := router.Group("/api/v1")
    {
        v1.POST("/students", controller.CreateStudent)
        v1.GET("/students/:id", controller.GetStudentByID)
        v1.PUT("/students/:id", controller.UpdateStudent)
        v1.DELETE("/students/:id", controller.DeleteStudent)
    }
    
    // æµ‹è¯•åˆ›å»ºå­¦ç”Ÿ
    createReq := models.CreateStudentRequest{
        Name:   "é›†æˆæµ‹è¯•å­¦ç”Ÿ",
        Age:    22,
        Gender: "å¥³",
        Email:  "integration@test.com",
    }
    
    jsonData, _ := json.Marshal(createReq)
    req, _ := http.NewRequest("POST", "/api/v1/students", bytes.NewBuffer(jsonData))
    req.Header.Set("Content-Type", "application/json")
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusCreated, w.Code)
    
    // è§£æåˆ›å»ºå“åº”è·å–ID
    var createResponse map[string]interface{}
    json.Unmarshal(w.Body.Bytes(), &createResponse)
    data := createResponse["data"].(map[string]interface{})
    studentID := int(data["id"].(float64))
    
    // æµ‹è¯•è·å–å­¦ç”Ÿ
    req, _ = http.NewRequest("GET", fmt.Sprintf("/api/v1/students/%d", studentID), nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // æµ‹è¯•æ›´æ–°å­¦ç”Ÿ
    updateReq := models.UpdateStudentRequest{
        Age: &[]int{23}[0],
    }
    
    jsonData, _ = json.Marshal(updateReq)
    req, _ = http.NewRequest("PUT", fmt.Sprintf("/api/v1/students/%d", studentID), bytes.NewBuffer(jsonData))
    req.Header.Set("Content-Type", "application/json")
    
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
    
    // æµ‹è¯•åˆ é™¤å­¦ç”Ÿ
    req, _ = http.NewRequest("DELETE", fmt.Sprintf("/api/v1/students/%d", studentID), nil)
    w = httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, http.StatusOK, w.Code)
}
```

## 5.7 æ€§èƒ½ä¼˜åŒ–

### å“åº”ç¼“å­˜

```go
// CacheMiddleware ç¼“å­˜ä¸­é—´ä»¶
func CacheMiddleware(duration time.Duration) gin.HandlerFunc {
    cache := make(map[string]CacheItem)
    mutex := sync.RWMutex{}
    
    return func(c *gin.Context) {
        // åªç¼“å­˜GETè¯·æ±‚
        if c.Request.Method != "GET" {
            c.Next()
            return
        }
        
        key := c.Request.URL.String()
        
        mutex.RLock()
        item, exists := cache[key]
        mutex.RUnlock()
        
        if exists && time.Now().Before(item.Expiry) {
            c.Data(item.StatusCode, item.ContentType, item.Data)
            return
        }
        
        // åˆ›å»ºå“åº”å†™å…¥å™¨
        writer := &CacheWriter{
            ResponseWriter: c.Writer,
            cache:          cache,
            key:            key,
            duration:       duration,
            mutex:          &mutex,
        }
        
        c.Writer = writer
        c.Next()
    }
}
```

### è¯·æ±‚é™æµ

```go
// RateLimitMiddleware é™æµä¸­é—´ä»¶
func RateLimitMiddleware(rate int, burst int) gin.HandlerFunc {
    limiter := rate.NewLimiter(rate.Limit(rate), burst)
    
    return func(c *gin.Context) {
        if !limiter.Allow() {
            utils.ErrorResponse(c, http.StatusTooManyRequests, "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•", nil)
            c.Abort()
            return
        }
        c.Next()
    }
}
```

## 5.8 ä¸‹ä¸€æ­¥

æ§åˆ¶å™¨å±‚å¼€å‘å®Œæˆåï¼Œä½ åº”è¯¥æŒæ¡ï¼š
- âœ… HTTPè¯·æ±‚å¤„ç†å’Œå“åº”æ ¼å¼åŒ–
- âœ… CRUDæ“ä½œçš„å®Œæ•´å®ç°
- âœ… é”™è¯¯å¤„ç†å’ŒéªŒè¯æœºåˆ¶
- âœ… ä¸­é—´ä»¶çš„ä½¿ç”¨å’Œè‡ªå®šä¹‰
- âœ… å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- âœ… æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨[ç¬¬6ç« ï¼šè·¯ç”±é…ç½®](./06-è·¯ç”±é…ç½®.md)ä¸­å­¦ä¹ å¦‚ä½•ç»„ç»‡å’Œé…ç½®åº”ç”¨ç¨‹åºçš„è·¯ç”±ã€‚

## å‚è€ƒèµ„æº

- [Ginæ¡†æ¶æ–‡æ¡£](https://gin-gonic.com/docs/)
- [HTTPçŠ¶æ€ç è§„èŒƒ](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
- [RESTful APIæœ€ä½³å®è·µ](https://restfulapi.net/)
- [Goæµ‹è¯•æ¡†æ¶Testify](https://github.com/stretchr/testify)