# ç¬¬3ç« ï¼šæ•°æ®åº“è®¾è®¡

æœ¬ç« å°†è¯¦ç»†ä»‹ç»å­¦ç”Ÿç®¡ç†ç³»ç»Ÿçš„æ•°æ®åº“è®¾è®¡ï¼ŒåŒ…æ‹¬SQLiteé…ç½®ã€GORMä½¿ç”¨å’Œæ•°æ®åº“è¿žæŽ¥ç®¡ç†ã€‚

## 3.1 æ•°æ®åº“é€‰æ‹©

### ä¸ºä»€ä¹ˆé€‰æ‹©SQLiteï¼Ÿ

**ä¼˜åŠ¿ï¼š**
- ðŸš€ **é›¶é…ç½®**ï¼šæ— éœ€å®‰è£…æ•°æ®åº“æœåŠ¡å™¨
- ðŸ“¦ **è½»é‡çº§**ï¼šæ•´ä¸ªæ•°æ®åº“å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶
- ðŸ”§ **æ˜“äºŽå¼€å‘**ï¼šé€‚åˆåŽŸåž‹å¼€å‘å’Œå°åž‹åº”ç”¨
- ðŸ”„ **ACIDæ”¯æŒ**ï¼šå®Œæ•´çš„äº‹åŠ¡æ”¯æŒ
- ðŸ“± **è·¨å¹³å°**ï¼šæ”¯æŒæ‰€æœ‰ä¸»æµæ“ä½œç³»ç»Ÿ

**é€‚ç”¨åœºæ™¯ï¼š**
- å¼€å‘å’Œæµ‹è¯•çŽ¯å¢ƒ
- å°åž‹åˆ°ä¸­åž‹åº”ç”¨
- åµŒå…¥å¼åº”ç”¨
- åŽŸåž‹å¼€å‘

**ç”Ÿäº§çŽ¯å¢ƒæ›¿æ¢ï¼š**
```go
// å¼€å‘çŽ¯å¢ƒï¼šSQLite
dsn := "students.db"

// ç”Ÿäº§çŽ¯å¢ƒï¼šMySQL
// dsn := "user:password@tcp(localhost:3306)/students?charset=utf8mb4&parseTime=True&loc=Local"

// ç”Ÿäº§çŽ¯å¢ƒï¼šPostgreSQL
// dsn := "host=localhost user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai"
```

## 3.2 GORMä»‹ç»

### ä»€ä¹ˆæ˜¯GORMï¼Ÿ

GORMæ˜¯Goè¯­è¨€çš„ORMï¼ˆObject-Relational Mappingï¼‰åº“ï¼Œæä¾›äº†ï¼š

- **æ¨¡åž‹å®šä¹‰**ï¼šç»“æž„ä½“æ˜ å°„åˆ°æ•°æ®åº“è¡¨
- **è‡ªåŠ¨è¿ç§»**ï¼šæ ¹æ®æ¨¡åž‹è‡ªåŠ¨åˆ›å»º/æ›´æ–°è¡¨ç»“æž„
- **æŸ¥è¯¢æž„å»ºå™¨**ï¼šé“¾å¼è°ƒç”¨æž„å»ºå¤æ‚æŸ¥è¯¢
- **å…³è”å…³ç³»**ï¼šä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³ç³»
- **é’©å­å‡½æ•°**ï¼šåœ¨æ“ä½œå‰åŽæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
- **è½¯åˆ é™¤**ï¼šé€»è¾‘åˆ é™¤è€Œéžç‰©ç†åˆ é™¤

### GORM vs åŽŸç”ŸSQL

| ç‰¹æ€§ | GORM | åŽŸç”ŸSQL |
|------|------|--------|
| å¼€å‘æ•ˆçŽ‡ | â­â­â­â­â­ | â­â­â­ |
| æ€§èƒ½ | â­â­â­â­ | â­â­â­â­â­ |
| ç±»åž‹å®‰å…¨ | â­â­â­â­â­ | â­â­ |
| å¯ç»´æŠ¤æ€§ | â­â­â­â­â­ | â­â­â­ |
| å­¦ä¹ æˆæœ¬ | â­â­â­ | â­â­â­â­ |

## 3.3 æ•°æ®åº“é…ç½®

### åˆ›å»ºé…ç½®æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„ï¼š** `config/database.go`

```go
package config

import (
    "log"
    "os"
    
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
    
    "your-project/models"
)

var DB *gorm.DB

// InitDatabase åˆå§‹åŒ–æ•°æ®åº“è¿žæŽ¥
func InitDatabase() {
    var err error
    
    // æ•°æ®åº“é…ç½®
    config := &gorm.Config{
        Logger: logger.Default.LogMode(logger.Info), // å¼€å¯SQLæ—¥å¿—
    }
    
    // è¿žæŽ¥SQLiteæ•°æ®åº“
    DB, err = gorm.Open(sqlite.Open("students.db"), config)
    if err != nil {
        log.Fatal("Failed to connect to database:", err)
    }
    
    log.Println("Database connected successfully")
    
    // è‡ªåŠ¨è¿ç§»
    err = DB.AutoMigrate(&models.Student{})
    if err != nil {
        log.Fatal("Failed to migrate database:", err)
    }
    
    log.Println("Database migration completed")
}

// GetDB èŽ·å–æ•°æ®åº“å®žä¾‹
func GetDB() *gorm.DB {
    return DB
}

// CloseDB å…³é—­æ•°æ®åº“è¿žæŽ¥
func CloseDB() {
    sqlDB, err := DB.DB()
    if err != nil {
        log.Printf("Failed to get database instance: %v", err)
        return
    }
    
    err = sqlDB.Close()
    if err != nil {
        log.Printf("Failed to close database: %v", err)
        return
    }
    
    log.Println("Database connection closed")
}
```

### é…ç½®è¯´æ˜Ž

**æ—¥å¿—çº§åˆ«ï¼š**
- `logger.Silent`ï¼šä¸è¾“å‡ºæ—¥å¿—
- `logger.Error`ï¼šåªè¾“å‡ºé”™è¯¯æ—¥å¿—
- `logger.Warn`ï¼šè¾“å‡ºè­¦å‘Šå’Œé”™è¯¯æ—¥å¿—
- `logger.Info`ï¼šè¾“å‡ºæ‰€æœ‰æ—¥å¿—ï¼ˆåŒ…æ‹¬SQLè¯­å¥ï¼‰

**è¿žæŽ¥æ± é…ç½®ï¼š**
```go
sqlDB, err := DB.DB()
if err == nil {
    // è®¾ç½®æœ€å¤§æ‰“å¼€è¿žæŽ¥æ•°
    sqlDB.SetMaxOpenConns(100)
    
    // è®¾ç½®æœ€å¤§ç©ºé—²è¿žæŽ¥æ•°
    sqlDB.SetMaxIdleConns(10)
    
    // è®¾ç½®è¿žæŽ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
    sqlDB.SetConnMaxLifetime(time.Hour)
}
```

## 3.4 å­¦ç”Ÿæ¨¡åž‹è®¾è®¡

### åŸºç¡€æ¨¡åž‹å®šä¹‰

**æ–‡ä»¶è·¯å¾„ï¼š** `models/student.go`

```go
package models

import (
    "time"
    
    "gorm.io/gorm"
)

// Student å­¦ç”Ÿæ¨¡åž‹
type Student struct {
    // åŸºç¡€å­—æ®µ
    ID        uint           `json:"id" gorm:"primaryKey"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `json:"-" gorm:"index"`
    
    // å­¦ç”Ÿä¿¡æ¯
    Name   string `json:"name" gorm:"not null;size:50" validate:"required,min=2,max=50"`
    Age    int    `json:"age" gorm:"not null" validate:"required,min=1,max=150"`
    Gender string `json:"gender" gorm:"not null;size:10" validate:"required,oneof=ç”· å¥³"`
    Email  string `json:"email" gorm:"unique;not null;size:100" validate:"required,email"`
    Phone  string `json:"phone" gorm:"size:20" validate:"omitempty,len=11"`
    Major  string `json:"major" gorm:"size:50" validate:"omitempty,max=50"`
    Grade  string `json:"grade" gorm:"size:20" validate:"omitempty,max=20"`
}

// TableName æŒ‡å®šè¡¨å
func (Student) TableName() string {
    return "students"
}
```

### GORMæ ‡ç­¾è¯¦è§£

| æ ‡ç­¾ | è¯´æ˜Ž | ç¤ºä¾‹ |
|------|------|------|
| `primaryKey` | ä¸»é”® | `gorm:"primaryKey"` |
| `not null` | éžç©ºçº¦æŸ | `gorm:"not null"` |
| `unique` | å”¯ä¸€çº¦æŸ | `gorm:"unique"` |
| `size` | å­—æ®µé•¿åº¦ | `gorm:"size:50"` |
| `index` | åˆ›å»ºç´¢å¼• | `gorm:"index"` |
| `default` | é»˜è®¤å€¼ | `gorm:"default:0"` |
| `autoIncrement` | è‡ªå¢ž | `gorm:"autoIncrement"` |
| `column` | æŒ‡å®šåˆ—å | `gorm:"column:student_name"` |
| `-` | å¿½ç•¥å­—æ®µ | `gorm:"-"` |

### éªŒè¯æ ‡ç­¾è¯¦è§£

| æ ‡ç­¾ | è¯´æ˜Ž | ç¤ºä¾‹ |
|------|------|------|
| `required` | å¿…å¡« | `validate:"required"` |
| `min` | æœ€å°å€¼/é•¿åº¦ | `validate:"min=2"` |
| `max` | æœ€å¤§å€¼/é•¿åº¦ | `validate:"max=50"` |
| `len` | å›ºå®šé•¿åº¦ | `validate:"len=11"` |
| `email` | é‚®ç®±æ ¼å¼ | `validate:"email"` |
| `oneof` | æžšä¸¾å€¼ | `validate:"oneof=ç”· å¥³"` |
| `omitempty` | ç©ºå€¼æ—¶è·³è¿‡éªŒè¯ | `validate:"omitempty,email"` |

## 3.5 æ•°æ®åº“æ“ä½œ

### åŸºç¡€CRUDæ“ä½œ

```go
package models

import (
    "errors"
    
    "gorm.io/gorm"
    "your-project/config"
)

// StudentService å­¦ç”ŸæœåŠ¡
type StudentService struct {
    db *gorm.DB
}

// NewStudentService åˆ›å»ºå­¦ç”ŸæœåŠ¡å®žä¾‹
func NewStudentService() *StudentService {
    return &StudentService{
        db: config.GetDB(),
    }
}

// Create åˆ›å»ºå­¦ç”Ÿ
func (s *StudentService) Create(student *Student) error {
    return s.db.Create(student).Error
}

// GetByID æ ¹æ®IDèŽ·å–å­¦ç”Ÿ
func (s *StudentService) GetByID(id uint) (*Student, error) {
    var student Student
    err := s.db.First(&student, id).Error
    if err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, errors.New("å­¦ç”Ÿä¸å­˜åœ¨")
        }
        return nil, err
    }
    return &student, nil
}

// GetAll èŽ·å–æ‰€æœ‰å­¦ç”Ÿ
func (s *StudentService) GetAll() ([]Student, error) {
    var students []Student
    err := s.db.Where("deleted_at IS NULL").Find(&students).Error
    return students, err
}

// Update æ›´æ–°å­¦ç”Ÿä¿¡æ¯
func (s *StudentService) Update(id uint, student *Student) error {
    return s.db.Model(&Student{}).Where("id = ?", id).Updates(student).Error
}

// Delete è½¯åˆ é™¤å­¦ç”Ÿ
func (s *StudentService) Delete(id uint) error {
    return s.db.Delete(&Student{}, id).Error
}

// Search æœç´¢å­¦ç”Ÿ
func (s *StudentService) Search(name, major, grade string) ([]Student, error) {
    var students []Student
    query := s.db.Where("deleted_at IS NULL")
    
    if name != "" {
        query = query.Where("name LIKE ?", "%"+name+"%")
    }
    if major != "" {
        query = query.Where("major LIKE ?", "%"+major+"%")
    }
    if grade != "" {
        query = query.Where("grade = ?", grade)
    }
    
    err := query.Find(&students).Error
    return students, err
}
```

### é«˜çº§æŸ¥è¯¢ç¤ºä¾‹

```go
// åˆ†é¡µæŸ¥è¯¢
func (s *StudentService) GetWithPagination(page, pageSize int) ([]Student, int64, error) {
    var students []Student
    var total int64
    
    // è®¡ç®—æ€»æ•°
    s.db.Model(&Student{}).Where("deleted_at IS NULL").Count(&total)
    
    // åˆ†é¡µæŸ¥è¯¢
    offset := (page - 1) * pageSize
    err := s.db.Where("deleted_at IS NULL").
        Offset(offset).
        Limit(pageSize).
        Find(&students).Error
    
    return students, total, err
}

// æŽ’åºæŸ¥è¯¢
func (s *StudentService) GetWithOrder(orderBy, order string) ([]Student, error) {
    var students []Student
    
    if order != "asc" && order != "desc" {
        order = "asc"
    }
    
    err := s.db.Where("deleted_at IS NULL").
        Order(orderBy + " " + order).
        Find(&students).Error
    
    return students, err
}

// ç»Ÿè®¡æŸ¥è¯¢
func (s *StudentService) GetStatistics() (map[string]interface{}, error) {
    var total int64
    var maleCount int64
    var femaleCount int64
    
    // æ€»å­¦ç”Ÿæ•°
    s.db.Model(&Student{}).Where("deleted_at IS NULL").Count(&total)
    
    // ç”·å­¦ç”Ÿæ•°
    s.db.Model(&Student{}).Where("deleted_at IS NULL AND gender = ?", "ç”·").Count(&maleCount)
    
    // å¥³å­¦ç”Ÿæ•°
    s.db.Model(&Student{}).Where("deleted_at IS NULL AND gender = ?", "å¥³").Count(&femaleCount)
    
    return map[string]interface{}{
        "total":       total,
        "male_count":  maleCount,
        "female_count": femaleCount,
    }, nil
}
```

## 3.6 æ•°æ®åº“è¿ç§»

### è‡ªåŠ¨è¿ç§»

```go
// åŸºç¡€è¿ç§»
func AutoMigrate() {
    db := config.GetDB()
    
    err := db.AutoMigrate(
        &Student{},
        // å…¶ä»–æ¨¡åž‹...
    )
    
    if err != nil {
        log.Fatal("Migration failed:", err)
    }
}
```

### æ‰‹åŠ¨è¿ç§»

```go
// åˆ›å»ºç´¢å¼•
func CreateIndexes() {
    db := config.GetDB()
    
    // ä¸ºé‚®ç®±åˆ›å»ºå”¯ä¸€ç´¢å¼•
    db.Exec("CREATE UNIQUE INDEX IF NOT EXISTS idx_students_email ON students(email)")
    
    // ä¸ºå§“ååˆ›å»ºç´¢å¼•
    db.Exec("CREATE INDEX IF NOT EXISTS idx_students_name ON students(name)")
    
    // ä¸ºä¸“ä¸šåˆ›å»ºç´¢å¼•
    db.Exec("CREATE INDEX IF NOT EXISTS idx_students_major ON students(major)")
}

// æ·»åŠ çº¦æŸ
func AddConstraints() {
    db := config.GetDB()
    
    // æ·»åŠ æ£€æŸ¥çº¦æŸ
    db.Exec("ALTER TABLE students ADD CONSTRAINT chk_age CHECK (age > 0 AND age < 150)")
}
```

### ç‰ˆæœ¬åŒ–è¿ç§»

```go
type Migration struct {
    Version     string
    Description string
    Up          func(*gorm.DB) error
    Down        func(*gorm.DB) error
}

var migrations = []Migration{
    {
        Version:     "001",
        Description: "Create students table",
        Up: func(db *gorm.DB) error {
            return db.AutoMigrate(&Student{})
        },
        Down: func(db *gorm.DB) error {
            return db.Migrator().DropTable(&Student{})
        },
    },
    {
        Version:     "002",
        Description: "Add indexes",
        Up: func(db *gorm.DB) error {
            db.Exec("CREATE INDEX idx_students_name ON students(name)")
            return nil
        },
        Down: func(db *gorm.DB) error {
            db.Exec("DROP INDEX idx_students_name")
            return nil
        },
    },
}
```

## 3.7 æ•°æ®åº“ä¼˜åŒ–

### ç´¢å¼•ä¼˜åŒ–

```go
// å¤åˆç´¢å¼•
type Student struct {
    // ...
    Name  string `gorm:"index:idx_name_major"`
    Major string `gorm:"index:idx_name_major"`
}

// æˆ–è€…åœ¨è¿ç§»ä¸­åˆ›å»º
db.Exec("CREATE INDEX idx_name_major ON students(name, major)")
```

### æŸ¥è¯¢ä¼˜åŒ–

```go
// ä½¿ç”¨SelectæŒ‡å®šå­—æ®µ
var students []Student
db.Select("id, name, email").Find(&students)

// ä½¿ç”¨Preloadé¢„åŠ è½½å…³è”
db.Preload("Courses").Find(&students)

// ä½¿ç”¨åŽŸç”ŸSQLä¼˜åŒ–å¤æ‚æŸ¥è¯¢
var result []map[string]interface{}
db.Raw("SELECT major, COUNT(*) as count FROM students WHERE deleted_at IS NULL GROUP BY major").Scan(&result)
```

### è¿žæŽ¥æ± ä¼˜åŒ–

```go
func OptimizeDB() {
    sqlDB, err := DB.DB()
    if err != nil {
        return
    }
    
    // è®¾ç½®æœ€å¤§æ‰“å¼€è¿žæŽ¥æ•°
    sqlDB.SetMaxOpenConns(25)
    
    // è®¾ç½®æœ€å¤§ç©ºé—²è¿žæŽ¥æ•°
    sqlDB.SetMaxIdleConns(5)
    
    // è®¾ç½®è¿žæŽ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
    sqlDB.SetConnMaxLifetime(5 * time.Minute)
    
    // è®¾ç½®è¿žæŽ¥æœ€å¤§ç©ºé—²æ—¶é—´
    sqlDB.SetConnMaxIdleTime(time.Minute)
}
```

## 3.8 äº‹åŠ¡å¤„ç†

### åŸºç¡€äº‹åŠ¡

```go
func (s *StudentService) CreateWithTransaction(student *Student) error {
    return s.db.Transaction(func(tx *gorm.DB) error {
        // åˆ›å»ºå­¦ç”Ÿ
        if err := tx.Create(student).Error; err != nil {
            return err
        }
        
        // å…¶ä»–ç›¸å…³æ“ä½œ...
        
        return nil
    })
}
```

### æ‰‹åŠ¨äº‹åŠ¡

```go
func (s *StudentService) ManualTransaction(student *Student) error {
    tx := s.db.Begin()
    defer func() {
        if r := recover(); r != nil {
            tx.Rollback()
        }
    }()
    
    if err := tx.Error; err != nil {
        return err
    }
    
    if err := tx.Create(student).Error; err != nil {
        tx.Rollback()
        return err
    }
    
    return tx.Commit().Error
}
```

## 3.9 æ•°æ®åº“æµ‹è¯•

### æµ‹è¯•æ•°æ®åº“é…ç½®

```go
func SetupTestDB() *gorm.DB {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    if err != nil {
        panic("failed to connect test database")
    }
    
    // è¿ç§»æµ‹è¯•è¡¨
    db.AutoMigrate(&Student{})
    
    return db
}
```

### æµ‹è¯•ç”¨ä¾‹

```go
func TestStudentCRUD(t *testing.T) {
    db := SetupTestDB()
    service := &StudentService{db: db}
    
    // æµ‹è¯•åˆ›å»º
    student := &Student{
        Name:   "å¼ ä¸‰",
        Age:    20,
        Gender: "ç”·",
        Email:  "zhangsan@example.com",
    }
    
    err := service.Create(student)
    assert.NoError(t, err)
    assert.NotZero(t, student.ID)
    
    // æµ‹è¯•æŸ¥è¯¢
    found, err := service.GetByID(student.ID)
    assert.NoError(t, err)
    assert.Equal(t, "å¼ ä¸‰", found.Name)
    
    // æµ‹è¯•æ›´æ–°
    found.Age = 21
    err = service.Update(found.ID, found)
    assert.NoError(t, err)
    
    // æµ‹è¯•åˆ é™¤
    err = service.Delete(found.ID)
    assert.NoError(t, err)
}
```

## 3.10 å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šè½¯åˆ é™¤è®°å½•ä»ç„¶æ˜¾ç¤º
**åŽŸå› ï¼š** æŸ¥è¯¢æ—¶æ²¡æœ‰è¿‡æ»¤è½¯åˆ é™¤è®°å½•
**è§£å†³ï¼š**
```go
// é”™è¯¯çš„æŸ¥è¯¢
db.Find(&students)

// æ­£ç¡®çš„æŸ¥è¯¢
db.Where("deleted_at IS NULL").Find(&students)
// æˆ–è€…ä½¿ç”¨UnscopedæŸ¥çœ‹æ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬è½¯åˆ é™¤ï¼‰
db.Unscoped().Find(&students)
```

### é—®é¢˜2ï¼šå”¯ä¸€çº¦æŸå†²çª
**åŽŸå› ï¼š** æ’å…¥é‡å¤çš„å”¯ä¸€å­—æ®µå€¼
**è§£å†³ï¼š**
```go
if err := db.Create(&student).Error; err != nil {
    if strings.Contains(err.Error(), "UNIQUE constraint failed") {
        return errors.New("é‚®ç®±å·²å­˜åœ¨")
    }
    return err
}
```

### é—®é¢˜3ï¼šæ—¶åŒºé—®é¢˜
**è§£å†³ï¼š**
```go
// è®¾ç½®æ—¶åŒº
loc, _ := time.LoadLocation("Asia/Shanghai")
time.Local = loc

// æˆ–åœ¨è¿žæŽ¥å­—ç¬¦ä¸²ä¸­æŒ‡å®š
// MySQL: parseTime=True&loc=Local
// PostgreSQL: TimeZone=Asia/Shanghai
```

## 3.11 ä¸‹ä¸€æ­¥

æ•°æ®åº“è®¾è®¡å®ŒæˆåŽï¼Œä½ åº”è¯¥æŽŒæ¡ï¼š
- âœ… SQLiteå’ŒGORMçš„åŸºæœ¬ä½¿ç”¨
- âœ… å­¦ç”Ÿæ¨¡åž‹çš„å®šä¹‰å’ŒéªŒè¯
- âœ… åŸºç¡€CRUDæ“ä½œçš„å®žçŽ°
- âœ… æ•°æ®åº“è¿žæŽ¥å’Œé…ç½®ç®¡ç†
- âœ… è½¯åˆ é™¤å’Œäº‹åŠ¡å¤„ç†

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨[ç¬¬4ç« ï¼šæ¨¡åž‹å±‚å¼€å‘](./04-æ¨¡åž‹å±‚å¼€å‘.md)ä¸­æ·±å…¥å­¦ä¹ æ¨¡åž‹å±‚çš„å…·ä½“å®žçŽ°ã€‚

## å‚è€ƒèµ„æº

- [GORMå®˜æ–¹æ–‡æ¡£](https://gorm.io/docs/)
- [SQLiteå®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)
- [Goæ•°æ®åº“æœ€ä½³å®žè·µ](https://go.dev/doc/database/)
- [æ•°æ®åº“è®¾è®¡è§„èŒƒ](https://dev.mysql.com/doc/refman/8.0/en/database-design.html)